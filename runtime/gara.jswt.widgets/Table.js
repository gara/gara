gara.provide("gara.jswt.widgets.Table");gara.use("gara.EventManager");gara.use("gara.jswt.JSWT");gara.parent("gara.jswt.widgets.Composite",function(){gara.Class("gara.jswt.widgets.Table",{$extends:gara.jswt.widgets.Composite,SCROLLBAR_WIDTH:19,items:[],columns:[],columnOrder:[],virtualColumn:null,headerVisible:false,linesVisible:false,table:null,thead:null,theadRow:null,tbody:null,checkboxCol:null,selection:[],selectionListeners:[],shiftItem:null,activeItem:null,$constructor:function(a,b){this.items=[];this.columns=[];this.columnOrder=[];this.virtualColumn=null;this.headerVisible=false;this.linesVisible=false;this.table=null;this.thead=null;this.theadRow=null;this.tbody=null;this.checkboxCol=null;this.event=null;this.selection=[];this.selectionListeners=[];this.shiftItem=null;this.activeItem=null;this.$super(a,b||gara.jswt.JSWT.SINGLE)},activateItem:function(a){this.checkWidget();if(!(a instanceof gara.jswt.widgets.TableItem)){throw new TypeError("item is not type of gara.jswt.widgets.TableItem");}if(this.activeItem!==null&&!this.activeItem.isDisposed()){this.activeItem.setActive(false)}this.activeItem=a;this.activeItem.setActive(true);this.handle.setAttribute("aria-activedescendant",this.activeItem.getId())},addItem:function(a,b){this.checkWidget();if(!(a instanceof gara.jswt.widgets.TableItem)){throw new TypeError("item is not a gara.jswt.widgets.TableItem");}if(typeof(b)!=="undefined"){this.items.insertAt(b,a)}else{this.items.push(a)}return this.tbody},addColumn:function(a,b){this.checkWidget();if(!(a instanceof gara.jswt.widgets.TableColumn)){throw new TypeError("column is not a gara.jswt.widgets.TableColumn");}if(b){this.columns[b]=a;if(!this.columnOrder.contains(b)){this.columnOrder.push(b)}}else{this.columns.push(a);this.columnOrder.push(this.columns.length-1)}return this.theadRow},addSelectionListener:function(a){if(!this.selectionListeners.contains(a)){this.selectionListeners.push(a)}},bindListener:function(a,b){gara.EventManager.addListener(this.handle,a,b)},clear:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}this.items[a].clear()},createWidget:function(){this.createHandle("div");this.handle.setAttribute("role","grid");this.handle.setAttribute("aria-multiselectable",(this.style&gara.jswt.JSWT.MULTI)===gara.jswt.JSWT.MULTI?true:false);this.handle.setAttribute("aria-activedescendant",this.getId());this.handle.setAttribute("aria-readonly",true);this.addClass("jsWTTable");this.setClass("jsWTTableLines",this.linesVisible);this.setClass("jsWTTableNoLines",!this.linesVisible);this.scroller=document.createElement("div");this.scroller.id=this.getId()+"-scroller";this.scroller.className="scroller";this.scroller.widget=this;this.scroller.control=this;this.scroller.setAttribute("role","presentation");this.handle.appendChild(this.scroller);this.table=document.createElement("table");this.table.id=this.getId()+"-table";this.table.widget=this;this.table.control=this;this.table.setAttribute("role","presentation");this.scroller.appendChild(this.table);this.thead=document.createElement("thead");this.thead.id=this.getId()+"-thead";this.thead.widget=this;this.thead.control=this;this.thead.setAttribute("role","presentation");this.table.appendChild(this.thead);this.theadRow=document.createElement("tr");this.theadRow.id=this.getId()+"-theadRow";this.theadRow.widget=this;this.theadRow.control=this;this.theadRow.setAttribute("role","row");this.thead.appendChild(this.theadRow);if((this.style&gara.jswt.JSWT.CHECK)===gara.jswt.JSWT.CHECK){this.checkboxCol=document.createElement("th");this.checkboxCol.className="jsWTTableCheckboxCol";this.checkboxCol.setAttribute("role","columnheader");this.theadRow.appendChild(this.checkboxCol);this.addClass("jsWTTableCheckbox")}this.tbody=document.createElement("tbody");this.tbody.id=this.getId()+"-tbody";this.tbody.widget=this;this.tbody.control=this;this.tbody.setAttribute("role","presentation");this.table.appendChild(this.tbody);if((this.style&gara.jswt.JSWT.FULL_SELECTION)===gara.jswt.JSWT.FULL_SELECTION){this.tbody.className="jsWTTableFullSelection"}this.addListener("mousedown",this);if((this.style&gara.jswt.JSWT.CHECK)===gara.jswt.JSWT.CHECK){this.addListener("mouseup",this)}},deselect:function(a){var b;this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}b=this.items[a];if(this.selection.contains(b)){b.setSelected(false);this.selection.remove(b);this.shiftItem=b;this.notifySelectionListener()}},deselectAll:function(){this.checkWidget();if(this.selection.length){while(this.selection.length){this.selection.pop().setSelected(false)}this.notifySelectionListener()}},deselectArray:function(b){if(this.selection.length){b.forEach(function(a){if(typeof(this.items.indexOf(a))=="undefined"){return}this.items[a].setSelected(false)},this);this.notifySelectionListener()}},deselectRange:function(a,b){for(var c=a;c<=b;c++){this.items[c].setSelected(false)}this.notifySelectionListener()},dispose:function(){this.deselectAll();this.$super();this.columns.forEach(function(a,b,c){a.dispose()},this);this.items.forEach(function(a,b,c){a.dispose()},this);this.thead.removeChild(this.theadRow);this.table.removeChild(this.thead);this.table.removeChild(this.tbody);this.scroller.removeChild(this.table);this.handle.removeChild(this.scroller);if(this.parentNode!==null){this.parentNode.removeChild(this.handle)}delete this.theadRow;delete this.thead;delete this.tbody;delete this.table;delete this.handle},focusGained:function(a){if(this.activeItem===null&&this.items.length){this.activateItem(this.items[0])}this.$super(a)},getColumn:function(a){this.checkWidget();if(typeof(this.columns.indexOf(a))=="undefined"){throw new RangeError("There is no column for the given index");}return this.columns[a]},getColumnCount:function(){return this.columns.length},getColumnOrder:function(){return this.columnOrder},getColumns:function(){return this.columns},getHeaderVisible:function(){return this.headerVisible},getItem:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}return this.items[a]},getItemCount:function(){return this.items.length},getItemHeight:function(a){return a.handle.offsetHeight+gara.getNumStyle(a.handle,"margin-top")+gara.getNumStyle(a.handle,"margin-bottom")},getItems:function(){return this.items},getLinesVisible:function(){return this.linesVisible},getSelection:function(){return this.selection},getSelectionCount:function(){return this.selection.length},getTopItem:function(){var a=this.scrolledHandle().scrollTop,b=0,c;if(!this.items.length){return null}for(c=0;c<this.items.length;c++){b+=this.getItemHeight(this.items[c]);if(b>a){return this.items[c]}}},handleEvent:function(a){var b;this.checkWidget();b=a.target.widget||null;a.item=b&&(b instanceof gara.jswt.widgets.TableItem||b instanceof gara.jswt.widgets.TableColumn)?b:this.activeItem;a.widget=this;this.event=a;this.handleMouseEvents(a);if(this.menu!==null&&this.menu.isVisible()){this.menu.handleEvent(a)}else{this.handleKeyEvents(a);this.handleMenu(a)}this.$super(a);if(a.item!==null){a.item.handleEvent(a)}if(a.type!=="mouseup"){a.stopPropagation()}return false},handleMouseEvents:function(a){var b=a.item;switch(a.type){case"mousedown":if(b instanceof gara.jswt.widgets.TableItem){this.activateItem(b);if(!a.ctrlKey&&!a.shiftKey){this.selectAdd(b,false)}else if(a.ctrlKey&&a.shiftKey){this.selectShift(b,true)}else if(a.shiftKey){this.selectShift(b,false)}else if(a.ctrlKey){if(this.selection.contains(b)){this.deselect(this.indexOf(b))}else{this.select(this.indexOf(b),true)}}else{this.select(this.indexOf(b))}}break}},handleKeyEvents:function(a){switch(a.type){case"keyup":case"keydown":case"keypress":if(a.type==="keydown"){this.handleKeyNavigation(a)}this.preventScrolling(a);break}},handleKeyNavigation:function(a){var b,c,d,e,g,h,f,i;switch(a.keyCode){case gara.jswt.JSWT.ARROW_UP:b=false;c=this.indexOf(this.activeItem);if(c!==0){b=this.items[c-1]}if(b){d=0;for(e=0;e<(c-1);e++){d+=this.getItemHeight(this.items[e])}g=this.scroller.clientHeight+this.scroller.scrollTop-gara.getNumStyle(this.scroller,"padding-top")-gara.getNumStyle(this.scroller,"padding-bottom");h=b.handle.clientHeight-gara.getNumStyle(b.handle,"padding-top")-gara.getNumStyle(b.handle,"padding-bottom");this.scroller.scrollTop=d<this.scroller.scrollTop?d:(g<d?d-g+h:this.scroller.scrollTop);if(!a.ctrlKey&&!a.shiftKey){this.activateItem(b);this.selectAdd(b,false)}else if(a.ctrlKey&&a.shiftKey){this.activateItem(b);this.selectShift(b,true)}else if(a.shiftKey){this.activateItem(b);this.selectShift(b,false)}else if(a.ctrlKey){this.activateItem(b)}}break;case gara.jswt.JSWT.ARROW_DOWN:f=false;c=this.indexOf(this.activeItem);if(c!==this.items.length-1){f=this.items[c+1]}if(f){d=0;for(e=0;e<=(c+1);e++){d+=this.getItemHeight(this.items[e])}i=d-this.getItemHeight(f);g=this.scroller.clientHeight+this.scroller.scrollTop-gara.getNumStyle(this.scroller,"padding-top")-gara.getNumStyle(this.scroller,"padding-bottom");scrollRange=d-this.scroller.clientHeight+gara.getNumStyle(this.scroller,"padding-top")+gara.getNumStyle(this.scroller,"padding-bottom");this.scroller.scrollTop=d>g?(scrollRange<0?0:scrollRange):(this.scroller.scrollTop>i?i:this.scroller.scrollTop);if(!a.ctrlKey&&!a.shiftKey){this.activateItem(f);this.selectAdd(f,false)}else if(a.ctrlKey&&a.shiftKey){this.activateItem(f);this.selectShift(f,true)}else if(a.shiftKey){this.activateItem(f);this.selectShift(f,false)}else if(a.ctrlKey){this.activateItem(f)}}break;case gara.jswt.JSWT.SPACE:if((this.style&gara.jswt.JSWT.CHECK)===gara.jswt.JSWT.CHECK){this.activeItem.setChecked(!this.activeItem.getChecked())}if(this.selection.contains(this.activeItem)&&a.ctrlKey){this.deselect(this.indexOf(this.activeItem))}else{this.selectAdd(this.activeItem,true)}break;case gara.jswt.JSWT.HOME:this.scroller.scrollTop=0;if(!a.ctrlKey&&!a.shiftKey){this.activateItem(this.items[0]);this.selectAdd(this.items[0],false)}else if(a.shiftKey){this.activateItem(this.items[0]);this.selectShift(this.items[0],false)}else if(a.ctrlKey){this.activateItem(this.items[0])}break;case gara.jswt.JSWT.END:this.scroller.scrollTop=this.scroller.scrollHeight-this.scroller.clientHeight;if(!a.ctrlKey&&!a.shiftKey){this.activateItem(this.items[this.items.length-1]);this.selectAdd(this.items[this.items.length-1],false)}else if(a.shiftKey){this.activateItem(this.items[this.items.length-1]);this.selectShift(this.items[this.items.length-1],false)}else if(a.ctrlKey){this.activateItem(this.items[this.items.length-1])}break}},indexOf:function(a){this.checkWidget();if(!(a instanceof gara.jswt.widgets.TableItem)){throw new TypeError("item not instance of gara.jswt.widgets.TableItem");}return this.items.indexOf(a)},getVerticalScrollbar:function(){return this.tbody.clientHeight>this.scroller.clientHeight},notifySelectionListener:function(){this.selectionListeners.forEach(function(a){if(a.widgetSelected){a.widgetSelected(this.event)}},this)},remove:function(a){var b;this.checkWidget();b=this.items.removeAt(a)[0];b.dispose();delete b},removeArray:function(b){this.checkWidget();b.forEach(function(a){this.remove(a)},this)},removeAll:function(){var a;this.checkWidget();while(this.items.length){a=this.items.pop();a.dispose();delete a}},removeRange:function(a,b){var c;this.checkWidget();for(c=a;c<=b;++c){this.remove(a)}},removeSelectionListener:function(a){this.selectionListeners.remove(a)},scrolledHandle:function(){return this.scroller},select:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}var b=this.items[a];if(!this.selection.contains(b)){b.setSelected(true);this.selection.push(b);this.shiftItem=b;this.notifySelectionListener()}},selectAdd:function(a,b){this.checkWidget();if(!(a instanceof gara.jswt.widgets.TableItem)){throw new TypeError("item not instance of gara.jswt.widgets.TableItem");}if(!b||(this.style&gara.jswt.JSWT.MULTI)!==gara.jswt.JSWT.MULTI){while(this.selection.length){this.selection.pop().setSelected(false)}}this.select(this.indexOf(a))},selectAll:function(){this.checkWidget();if((this.style&gara.jswt.JSWT.MULTI)===gara.jswt.JSWT.MULTI){this.items.forEach(function(a){if(!this.selection.contains(a)){a.setSelected(true);this.selection.push(a)}},this);this.notifySelectionListener()}},selectArray:function(b){if(!b.length){return}if(b.length>1&&(this.style&gara.jswt.JSWT.MULTI)===gara.jswt.JSWT.MULTI){b.forEach(function(a){if(!this.selection.contains(this.items[a])){this.items[a].setSelected(true);this.selection.push(this.items[a])}},this);this.notifySelectionListener()}else{this.select(b[b.length-1])}},selectRange:function(a,b){var c;if((b-a)>1&&(this.style&gara.jswt.JSWT.MULTI)===gara.jswt.JSWT.MULTI){for(c=a;c<=b;c++){if(!this.selection.contains(this.items[c])){this.items[c].setSelected(true);this.selection.push(this.items[c])}}this.notifySelectionListener()}else{this.select(b)}},selectShift:function(a,b){var c,d,e,g;this.checkWidget();if(!(a instanceof gara.jswt.widgets.TableItem)){throw new TypeError("item is not type of gara.jswt.widgets.TableItem");}if(!b){while(this.selection.length){this.selection.pop().setSelected(false)}}if((this.style&gara.jswt.JSWT.MULTI)===gara.jswt.JSWT.MULTI){c=this.indexOf(this.shiftItem);d=this.indexOf(a);e=c>d?d:c;g=c<d?d:c;for(var h=e;h<=g;++h){this.selection.push(this.items[h]);this.items[h].setSelected(true)}this.notifySelectionListener()}else{this.select(this.indexOf(a))}},setSelection:function(b){var c;this.checkWidget();while(this.selection.length){c=this.selection.pop();if(!c.isDisposed()){c.setSelected(false)}}if(b instanceof Array){if(b.length>1&&(this.style&gara.jswt.JSWT.MULTI)===gara.jswt.JSWT.MULTI){b.forEach(function(a){if(!this.selection.contains(a)){a.setSelected(true);this.selection.push(a)}},this);this.notifySelectionListener()}else if(b.length){this.select(this.items.indexOf(b[b.length-1]))}}else if(b instanceof gara.jswt.widgets.TableItem){this.select(this.indexOf(b))}return this},setColumnOrder:function(a){this.columnOrder=a;return this},setHeaderVisible:function(a){this.headerVisible=a;if(this.thead!==null){this.thead.style.display=this.headerVisible?(document.all?"block":"table-row-group"):"none"}return this},setHeight:function(a){this.height=a;heightSub=gara.getNumStyle(this.handle,"padding-bottom")+gara.getNumStyle(this.handle,"border-top-width")+gara.getNumStyle(this.handle,"border-bottom-width");this.handle.style.height=this.height!==null?(this.height-this.thead.offsetHeight-heightSub)+"px":"auto";this.scroller.style.height=this.height!==null?(this.height-this.thead.offsetHeight-heightSub)+"px":"auto";if(this.headerVisible){this.handle.style.paddingTop=this.thead.offsetHeight+"px"}return this},setLinesVisible:function(a){this.linesVisible=a;this.setClass("jsWTTableLines",this.linesVisible);this.setClass("jsWTTableNoLines",!this.linesVisible);return this},setTopItem:function(a){var b,c=0,d;if(!(a instanceof gara.jswt.widgets.TableItem)){throw new TypeError("item not instance of gara.jswt.widgets.TableItem");}b=this.indexOf(a);for(d=0;d<b;d++){c+=this.getItemHeight(this.items[b])}this.scrolledHandle().scrollTop=c;return this},setWidth:function(d){var e;if(d!==null){this.width=d;d=d-gara.getNumStyle(this.handle,"padding-left")-gara.getNumStyle(this.handle,"padding-right")-gara.getNumStyle(this.handle,"border-left-width")-gara.getNumStyle(this.handle,"border-right-width");this.handle.style.width=d+"px";this.thead.style.width=d+"px";e=0;this.columns.forEach(function(a,b){var c;if(!a.getWidth()){c=Math.floor(d/this.columns.length);e+=c;a.setWidth(b===this.columns.length-1?d-e:c)}},this)}else{this.handle.style.width="auto";this.width=this.handle.offsetWidth;this.thead.style.width=this.width-gara.getNumStyle(this.handle,"padding-left")-gara.getNumStyle(this.handle,"padding-right")-gara.getNumStyle(this.handle,"border-left-width")-gara.getNumStyle(this.handle,"border-right-width")+"px"}return this},showItem:function(a){var b,c,d,e;if(!(a instanceof gara.jswt.widgets.TableItem)){throw new TypeError("item not instance of gara.jswt.widgets.TableItem");}if(this.getVerticalScrollbar()){b=this.indexOf(a);c=0;for(d=0;d<=b;d++){c+=this.getItemHeight(this.items[d])}if((this.scrolledHandle().scrollTop+this.scrolledHandle().clientHeight)<c||this.scrolledHandle().scrollTop>c){e=c-Math.round(this.getItemHeight(this.items[b])/2)-Math.round(this.scrolledHandle().clientHeight/2);this.scrolledHandle().scrollTop=e}}},showSelection:function(){if(this.selection.length){this.showItem(this.selection[0])}},unbindListener:function(a,b){gara.EventManager.removeListener(this.handle,a,b)},update:function(){var d,e;this.checkWidget();if(this.virtualColumn&&this.columns.length){this.virtualColumn.dispose();this.virtualColumn=null}while(this.theadRow.childNodes.length&&this.columns.length){this.theadRow.removeChild(this.theadRow.childNodes[0])}if((this.style&gara.jswt.JSWT.CHECK)===gara.jswt.JSWT.CHECK){this.theadRow.appendChild(this.checkboxCol)}if(!this.columns.length){this.virtualColumn=new gara.jswt.widgets.TableColumn(this);this.columns=[];this.columnOrder=[]}for(d=0,len=this.columnOrder.length;d<len;++d){var e=this.columns[this.columnOrder[d]];if(e.isDisposed()){this.columns.remove(e)}else{e.update();this.theadRow.appendChild(e.handle)}}for(d=0,len=this.columnOrder.length;d<len;++d){e=this.columns[this.columnOrder[d]];e.setWidth(e.getWidth()+(d===(len-1)&&this.getVerticalScrollbar()?19:0))}this.items.forEach(function(a,b,c){a.update()},this);this.updateMeasurements()},updateMeasurements:function(){var a,b;if(this.width!==null){a=this.width-gara.getNumStyle(this.handle,"padding-left")-gara.getNumStyle(this.handle,"padding-right")-gara.getNumStyle(this.handle,"border-left-width")-gara.getNumStyle(this.handle,"border-right-width");this.handle.style.width=a+"px";this.thead.style.width=a+"px"}b=gara.getNumStyle(this.handle,"padding-bottom")+gara.getNumStyle(this.handle,"border-top-width")+gara.getNumStyle(this.handle,"border-bottom-width");this.handle.style.height=this.height!==null?(this.height-this.thead.offsetHeight-b)+"px":"auto";this.scroller.style.height=this.height!==null?(this.height-this.thead.offsetHeight-b)+"px":"auto";if(this.headerVisible){this.handle.style.paddingTop=this.thead.offsetHeight+"px"}if(this.items.length){this.items[0].adjustWidth()}}})});