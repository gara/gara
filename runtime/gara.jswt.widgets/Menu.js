gara.provide("gara.jswt.widgets.Menu");gara.use("gara.EventManager");gara.use("gara.jswt.JSWT");gara.parent("gara.jswt.widgets.Composite",function(){gara.Class("gara.jswt.widgets.Menu",{$extends:gara.jswt.widgets.Composite,activeItem:null,enabled:false,items:[],menuBarDropDownShown:false,menuListeners:[],visible:false,x:0,y:0,$constructor:function(a,c){if(a instanceof gara.jswt.widgets.MenuItem&&(a.getStyle()&gara.jswt.JSWT.CASCADE)!==gara.jswt.JSWT.CASCADE){throw new TypeError("parent has no gara.jswt.JSWT.CASCADE style!");}if(a instanceof gara.jswt.widgets.Control){c|=gara.jswt.JSWT.POP_UP}if(a instanceof gara.jswt.widgets.MenuItem){c|=gara.jswt.JSWT.DROP_DOWN}if(((c&gara.jswt.JSWT.POP_UP)!==gara.jswt.JSWT.POP_UP&&(c&gara.jswt.JSWT.DROP_DOWN)!==gara.jswt.JSWT.DROP_DOWN)||(c&gara.jswt.JSWT.TOOLBAR)===gara.jswt.JSWT.TOOLBAR){c|=gara.jswt.JSWT.BAR}this.items=[];this.menuListener=[];this.activeItem=null;this.x=0;this.y=0;this.enabled=false;this.visible=(c&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR;this.menuBarDropDownShown=false;this.$super(a,c)},bindListener:function(a,c){gara.EventManager.addListener(this.handle,a,c)},activateItem:function(a){var c;if(this.activeItem===a){return}if(this.activeItem!==null){this.activeItem.setActive(false);if(this.activeItem.getMenu()!==null){this.activeItem.getMenu().setVisible(false)}}this.activeItem=a;if((this.activeItem.getParent().getStyle()&gara.jswt.JSWT.TOOLBAR)!==gara.jswt.JSWT.TOOLBAR||(this.event!==null&&this.event.type&&(this.event.type==="keydown"||this.event.type==="keyup"||this.event.type==="keypress"||this.event.type==="focus"))){this.activeItem.setActive(true)}c=this.activeItem.getMenu();if(this.menuBarDropDownShown&&c!==null){c.setVisible(true)}},addItem:function(a,c){this.checkWidget();if(!(a instanceof gara.jswt.widgets.MenuItem)){throw new TypeError("item is not instance of gara.jswt.widgets.MenuItem");}c=c||this.items.length;this.items.insertAt(c,a);return this.handle},addMenuListener:function(a){this.checkWidget();if(!this.menuListener.contains(a)){this.menuListener.push(a)}return this},createWidget:function(){this.createHandle("ul",true);this.handle.style.display=this.visible?"block":"none";this.handle.setAttribute("id",this.getId());this.handle.setAttribute("role","menu");this.addClass("jsWTMenu");if(!(this.parent instanceof gara.jswt.widgets.MenuItem)){this.addListener("mouseover",this);this.addListener("mouseout",this);this.addListener("mouseup",this);this.addListener("mousedown",this)}if((this.style&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR){this.addClass("jsWTMenuBar");this.parentNode=this.parent;this.handle.setAttribute("role","menubar");gara.EventManager.addListener(document,"mousedown",this);if((this.style&gara.jswt.JSWT.TOOLBAR)===gara.jswt.JSWT.TOOLBAR){this.addClass("jsWTToolbar")}if(this.parent instanceof gara.jswt.widgets.Composite){this.parentNode=this.parent.handle}}if((this.style&gara.jswt.JSWT.POP_UP)===gara.jswt.JSWT.POP_UP){this.addClass("jsWTMenuPopUp");this.handle.tabIndex=-1;this.handle.style.position="absolute";this.handle.style.top=this.y+"px";this.handle.style.left=this.x+"px";this.parentNode=document.getElementsByTagName("body")[0]}if((this.style&gara.jswt.JSWT.DROP_DOWN)===gara.jswt.JSWT.DROP_DOWN){this.addClass("jsWTMenuDropDown");this.handle.tabIndex=-1;this.handle.style.position="absolute";this.parentNode=this.parent.handle}this.parentNode.appendChild(this.handle)},dispose:function(){this.$super();this.items.forEach(function(a,c,b){a.dispose()},this);this.parentNode.removeChild(this.handle);delete this.handle},focusGained:function(a){this.event=a;if(this.items.length&&this.activeItem===null){if(a.target.widget&&a.target.widget instanceof gara.jswt.widgets.MenuItem&&a.target.widget.getParent()===this){this.activateItem(a.target.widget)}else{this.activateItem(this.items[0])}}this.$super(a)},focusLost:function(a){this.event=a;if(this.activeItem){if(this.activeItem.getMenu()!==null&&this.activeItem.getMenu().getVisible()){this.activeItem.getMenu().setVisible(false)}this.activeItem.setActive(false);this.activeItem=null}this.$super(a)},getItem:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}return this.items[a]},getItemCount:function(){return this.items.length},getItems:function(){return this.items},getParent:function(){return this.parent},getParentItem:function(){return this.parent},getVisible:function(){return this.visible},handleEvent:function(b){var d,e,g;this.checkWidget();b.widget=this;this.event=b;e=function(a){var c=a;a.setSelection((a.getStyle()&gara.jswt.JSWT.RADIO)===gara.jswt.JSWT.RADIO?true:!a.getSelection());while(c.getParent()!==null&&((c.getParent()instanceof gara.jswt.widgets.Menu&&(c.getParent().getStyle()&gara.jswt.JSWT.BAR)!==gara.jswt.JSWT.BAR)||c.getParent()instanceof gara.jswt.widgets.MenuItem)){c=c.getParent();if(c instanceof gara.jswt.widgets.Menu){c.setVisible(false)}}if(c.getParent()!==null&&c.getParent()instanceof gara.jswt.widgets.Menu&&(c.getParent().getStyle()&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR){c.getParent().hideMenuBarDropDown()}if(a.getParent()!==null&&(a.getParent().getStyle()&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR&&a.getParent()===this&&this.hasFocus){a.getParent().handle.blur()}};switch(b.type){case"mousedown":if(b.target.widget&&b.target.widget instanceof gara.jswt.widgets.MenuItem&&b.target.widget.getParent()===this&&(this.getStyle()&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR){this.activateItem(b.target.widget)}if((b.target.widget?b.target.widget!==this:true)&&(this.getStyle()&gara.jswt.JSWT.POP_UP)===gara.jswt.JSWT.POP_UP&&!(b.target.widget instanceof gara.jswt.widgets.MenuItem)){this.setVisible(false)}else if((b.target.widget?b.target.widget!==this&&b.target.widget.getParent()!==this:true)&&(this.getStyle()&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR){var f,h;if(this.activeItem){if(b.target.widget&&(b.target.widget instanceof gara.jswt.widgets.Menu||b.target.widget instanceof gara.jswt.widgets.MenuItem)){f=b.target.widget;while(f.getParent()!==null&&(f.getParent()instanceof gara.jswt.widgets.Menu||f.getParent()instanceof gara.jswt.widgets.MenuItem)&&f!==this){f=f.getParent()}}h=f===this;if(this.activeItem.getMenu()!==null&&this.activeItem.getMenu().getVisible()&&!h){this.activeItem.getMenu().setVisible(false)}this.activeItem.setActive(false);this.activeItem=null}}break;case"mouseup":if((b.target.widget&&(b.target.widget instanceof gara.jswt.widgets.MenuItem||b.target.widget instanceof gara.jswt.widgets.Menu||this.activeItem!==null))){g=b.target.widget instanceof gara.jswt.widgets.MenuItem?b.target.widget:(b.target.widget.activeItem!==null?b.target.widget.activeItem:this.activeItem);if(g!==null){e(g)}}break;case"mouseover":if(b.target.widget&&b.target.widget instanceof gara.jswt.widgets.MenuItem&&(b.target.widget.getStyle()&gara.jswt.JSWT.SEPARATOR)!==gara.jswt.JSWT.SEPARATOR){d=b.target.widget;if(d.getParent()===this&&d.getEnabled()){this.activateItem(b.target.widget);if(this.activeItem.getMenu()!==null&&((this.style&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR?this.hasFocus:true)){this.activeItem.getMenu().setVisible(true)}}else if(this.activeItem&&this.activeItem.getMenu()!==null&&this.activeItem.getMenu().getVisible()){this.activeItem.getMenu().handleEvent(b)}}else if(b.target.widget&&b.target.widget===this&&this.activeItem!==null){this.activeItem.setActive(false);this.activeItem=null}break;case"mouseout":if(b.target.widget&&(b.target.widget===this||b.target.widget.getParent()===this)&&!this.hasFocus&&this.activeItem!==null){this.activeItem.setActive(false);this.activeItem=null}break;case"keydown":if(this.activeItem&&this.activeItem.getMenu()!==null&&this.activeItem.getMenu().getVisible()){this.activeItem.getMenu().handleEvent(b)}else{if(b.keyCode===gara.jswt.JSWT.ENTER){e(this.activeItem)}this.handleKeyNavigation(b);this.preventScrolling(b)}break}this.$super(b);if(this.activeItem){this.activeItem.handleEvent(b)}b.stopPropagation()},handleKeyNavigation:function(c){var b=function(){var a=this.indexOf(this.activeItem)-1;while(a>=0&&(!this.items[a].getEnabled()||!this.items[a].getVisible()||(this.items[a].getStyle()&gara.jswt.JSWT.SEPARATOR)===gara.jswt.JSWT.SEPARATOR)){a--}if(a>=0){this.activateItem(this.items[a])}},d=function(){var a=this.indexOf(this.activeItem)+1;while(a<this.items.length&&(!this.items[a].getEnabled()||!this.items[a].getVisible()||(this.items[a].getStyle()&gara.jswt.JSWT.SEPARATOR)===gara.jswt.JSWT.SEPARATOR)){a++}if(a<this.items.length){this.activateItem(this.items[a])}},e=function(){return this.getParent()!==null&&this.getParent().getParent()!==null&&this.getParent().getParent()instanceof gara.jswt.widgets.Menu};if((this.style&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR){switch(c.keyCode){case gara.jswt.JSWT.ARROW_LEFT:b.call(this);break;case gara.jswt.JSWT.ARROW_RIGHT:d.call(this);break;case gara.jswt.JSWT.ARROW_DOWN:if(this.activeItem&&this.activeItem.getMenu()!==null){this.menuBarDropDownShown=true;this.activeItem.getMenu().setVisible(true)}break}}else{switch(c.keyCode){case gara.jswt.JSWT.ARROW_UP:b.call(this);break;case gara.jswt.JSWT.ARROW_DOWN:d.call(this);break;case gara.jswt.JSWT.ESC:this.setVisible(false);if(e.call(this)&&(this.getParent().getParent().getStyle()&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR){this.getParent().getParent().hideMenuBarDropDown()}break;case gara.jswt.JSWT.ARROW_LEFT:if(e.call(this)&&(this.getParent().getParent().getStyle()&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR){this.getParent().getParent().handleKeyNavigation(c)}else if(e.call(this)&&(this.getParent().getParent().getStyle()&gara.jswt.JSWT.BAR)!==gara.jswt.JSWT.BAR){this.setVisible(false)}break;case gara.jswt.JSWT.ARROW_RIGHT:if(this.activeItem.getMenu()!==null){this.activeItem.getMenu().setVisible(true)}else if(e.call(this)&&(this.getParent().getParent().getStyle()&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR){this.getParent().getParent().handleKeyNavigation(c)}break}}},hideMenuBarDropDown:function(){this.menuBarDropDownShown=false},indexOf:function(a){this.checkWidget();if(!(a instanceof gara.jswt.widgets.MenuItem)){throw new TypeError("item is not instance of gara.jswt.widgets.MenuItem");}return this.items.indexOf(a)},isVisible:function(){return this.visible},removeMenuListener:function(a){this.checkWidget();this.menuListener.remove(a)},setEnabled:function(a){this.$super(a);this.handle.tabIndex=this.enabled&&(style&gara.jswt.JSWT.BAR)===gara.jswt.JSWT.BAR?0:-1;return this},setLocation:function(a,c){this.x=a;this.y=c;this.handle.style.top=this.y+"px";this.handle.style.left=this.x+"px";return this},setVisible:function(d,e){this.checkWidget();this.visible=d;this.handle.style.display=this.visible?"block":"none";if(d){if((this.style&gara.jswt.JSWT.BAR)!==gara.jswt.JSWT.BAR){if(this.items.length){this.activateItem(this.items[0])}}if((this.style&gara.jswt.JSWT.POP_UP)===gara.jswt.JSWT.POP_UP){gara.EventManager.addListener(document,"mousedown",this);if(this.parent instanceof gara.jswt.widgets.Control){this.parent.addListener("mousedown",this)}}this.menuListeners.forEach(function(a,c,b){if(a.menuShown){a.menuShown(this)}},this)}else{if((this.style&gara.jswt.JSWT.POP_UP)===gara.jswt.JSWT.POP_UP){gara.EventManager.removeListener(document,"mousedown",this);if(this.parent instanceof gara.jswt.widgets.Control){this.parent.removeListener("mousedown",this)}}this.items.forEach(function(a){if(a.getMenu()!==null){a.getMenu().setVisible(false)}},this);this.menuListeners.forEach(function(a,c,b){if(a.menuHidden){a.menuHidden(this)}},this)}return this},unbindListener:function(a,c){gara.EventManager.removeListener(this.handle,a,c)},update:function(){this.checkWidget();if(!this.handle){this.create()}this.items.forEach(function(a){a.update()},this)}})});