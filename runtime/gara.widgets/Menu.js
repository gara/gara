gara.provide("gara.widgets.Menu","gara.widgets.Control");gara.use("gara.widgets.Decorations");gara.use("gara.widgets.MenuItem");gara.Class("gara.widgets.Menu",function(){return{$extends:gara.widgets.Control,activeItem:null,enabled:false,items:[],menuBarDropDownShown:false,toolBarDropDownShown:false,menuListeners:[],x:0,y:0,$constructor:function(a,c){if(a instanceof gara.widgets.MenuItem&&(a.getStyle()&gara.CASCADE)!==gara.CASCADE){throw new TypeError("parent has no gara.CASCADE style!");}if(a instanceof gara.widgets.Control){c|=gara.POP_UP}if(a instanceof gara.widgets.MenuItem){c|=gara.DROP_DOWN}c=gara.widgets.Menu.checkStyle(c);this.items=[];this.menuListeners=[];this.activeItem=null;this.x=0;this.y=0;this.enabled=false;this.menuBarDropDownShown=false;this.toolBarDropDownShown=false;this.$super(a,c);this.addFocusListener(this)},bindListener:function(a,c){gara.addEventListener(this.handle,a,c)},activateItem:function(a){var c;if(this.activeItem===a){return}if(this.activeItem!==null){this.activeItem.setActive(false);if(this.activeItem.getMenu()!==null){this.activeItem.getMenu().setVisible(false)}}this.activeItem=a;this.activeItem.setActive(true);c=this.activeItem.getMenu();if((this.style&gara.TOOLBAR)!==0&&this.toolBarDropDownShown&&c!==null){c.setVisible(true)}if((this.style&gara.TOOLBAR)===0&&(this.style&gara.BAR)!==0&&this.menuBarDropDownShown&&c!==null){c.setVisible(true)}},addItem:function(a,c){this.checkWidget();if(!(a instanceof gara.widgets.MenuItem)){throw new TypeError("item is not instance of gara.widgets.MenuItem");}c=c||this.items.length;this.items.insertAt(c,a);return this.handle},addMenuListener:function(a){this.checkWidget();if(!this.menuListeners.contains(a)){this.menuListeners.add(a)}return this},checkStyle:gara.$static(function(a){if((a&gara.TOOLBAR)!==0){a|=gara.BAR}a=gara.widgets.Widget.checkBits(a,gara.BAR,gara.POP_UP,gara.DROP_DOWN);if(a===0){a=gara.BAR}return a}),createWidget:function(){this.visible=(this.style&gara.BAR)!==0;this.createHandle("ul",true);this.handle.style.display=this.visible?"block":"none";this.handle.setAttribute("id",this.getId());this.handle.setAttribute("role","menu");this.addClass("garaMenu");if(!(this.parent instanceof gara.widgets.MenuItem)){this.addListener("mouseover",this);this.addListener("mouseout",this);this.addListener("mouseup",this);this.addListener("mousedown",this)}if((this.style&gara.BAR)!==0){this.addClass("garaMenuBar");this.handle.setAttribute("role","menubar");gara.addEventListener(document,"mousedown",this);if((this.style&gara.TOOLBAR)!==0){this.addClass("garaToolbar")}}if((this.style&gara.POP_UP)!==0){this.addClass("garaMenuPopUp");this.handle.tabIndex=-1;this.handle.style.position="absolute";this.handle.style.top=this.y+"px";this.handle.style.left=this.x+"px";this.parentNode=document.getElementsByTagName("body")[0]}if((this.style&gara.DROP_DOWN)!==0){this.addClass("garaMenuDropDown");this.handle.tabIndex=-1;this.handle.style.position="absolute";this.parentNode=this.parent.handle}this.parentNode.appendChild(this.handle)},destroyWidget:function(){this.menuListeners=null;this.activeItem=null;this.items=null;this.$super()},focusGained:function(a){this.menuBarDropDownShown=false;this.toolBarDropDownShown=false;this.event=a;if(this.items.length&&this.activeItem===null){if(a.target&&a.target.widget&&a.target.widget instanceof gara.widgets.MenuItem&&a.target.widget.getParent()===this){this.activateItem(a.target.widget)}else{this.activateItem(this.items[0])}}},focusLost:function(a){this.event=a;if(this.activeItem){if(this.activeItem.getMenu()!==null&&this.activeItem.getMenu().getVisible()){this.activeItem.getMenu().setVisible(false)}this.activeItem.setActive(false);this.activeItem=null}},getItem:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}return this.items[a]},getItemCount:function(){return this.items.length},getItems:function(){return this.items},getParent:function(){return this.parent},getParentItem:function(){return this.parent},handleEvent:function(b){var f,d,g;this.checkWidget();b.widget=this;this.event=b;d=function(a){var c=a;a.setSelection((a.getStyle()&gara.RADIO)===gara.RADIO?true:!a.getSelection());while(c.getParent()!==null&&((c.getParent()instanceof gara.widgets.Menu&&(c.getParent().getStyle()&gara.BAR)!==gara.BAR)||c.getParent()instanceof gara.widgets.MenuItem)){c=c.getParent();if(c instanceof gara.widgets.Menu){c.setVisible(false)}}if(c.getParent()!==null&&c.getParent()instanceof gara.widgets.Menu&&(c.getParent().getStyle()&gara.BAR)===gara.BAR){c.getParent().hideMenuBarDropDown()}if(a.getParent()!==null&&(a.getParent().getStyle()&gara.BAR)===gara.BAR&&a.getParent()===this&&this.isFocusControl()){a.getParent().handle.blur()}};switch(b.type){case"mousedown":if(b.target.widget&&b.target.widget instanceof gara.widgets.MenuItem&&b.target.widget.getParent()===this&&(this.getStyle()&gara.BAR)===gara.BAR){this.activateItem(b.target.widget);if(b.target.widget.getMenu()!==null){b.target.widget.getMenu().setVisible(true)}}if((b.target.widget?b.target.widget!==this:true)&&(this.getStyle()&gara.POP_UP)===gara.POP_UP&&!(b.target.widget instanceof gara.widgets.MenuItem)){this.setVisible(false)}else if((b.target.widget?b.target.widget!==this&&b.target.widget.getParent()!==this:true)&&(this.getStyle()&gara.BAR)===gara.BAR){var e,h;if(this.activeItem){if(b.target.widget&&(b.target.widget instanceof gara.widgets.Menu||b.target.widget instanceof gara.widgets.MenuItem)){e=b.target.widget;while(e.getParent()!==null&&(e.getParent()instanceof gara.widgets.Menu||e.getParent()instanceof gara.widgets.MenuItem)&&e!==this){e=e.getParent()}}h=e===this;if(this.activeItem.getMenu()!==null&&this.activeItem.getMenu().getVisible()&&!h){this.activeItem.getMenu().setVisible(false)}this.activeItem.setActive(false);this.activeItem=null}}break;case"mouseup":if((b.target.widget&&(b.target.widget instanceof gara.widgets.MenuItem||b.target.widget instanceof gara.widgets.Menu||this.activeItem!==null))){g=b.target.widget instanceof gara.widgets.MenuItem?b.target.widget:(b.target.widget.activeItem!==null?b.target.widget.activeItem:this.activeItem);if(typeof(g)!=="undefined"&&g!==null){d(g)}}break;case"mouseover":if(b.target.widget&&b.target.widget instanceof gara.widgets.MenuItem&&(b.target.widget.getStyle()&gara.SEPARATOR)!==gara.SEPARATOR){f=b.target.widget;if(f.getParent()===this&&f.getEnabled()){this.activateItem(b.target.widget);if(this.activeItem.getMenu()!==null&&((this.style&gara.BAR)===gara.BAR?this.isFocusControl():true)){this.activeItem.getMenu().setVisible(true)}}else if(this.activeItem&&this.activeItem.getMenu()!==null&&this.activeItem.getMenu().getVisible()){this.activeItem.getMenu().handleEvent(b)}}else if(b.target.widget&&b.target.widget===this&&this.activeItem!==null){this.activeItem.setActive(false);this.activeItem=null}break;case"mouseout":if(b.target.widget&&(b.target.widget===this||b.target.widget.getParent()===this)&&!this.isFocusControl()&&this.activeItem!==null){this.activeItem.setActive(false);this.activeItem=null}break;case"keydown":if(this.activeItem&&this.activeItem.getMenu()!==null&&this.activeItem.getMenu().getVisible()){this.activeItem.getMenu().handleEvent(b)}else{if(b.keyCode===gara.ENTER){d(this.activeItem)}if(b.keyCode===gara.ESC){b.preventShellClose=true}this.handleKeyNavigation(b);this.preventScrolling(b)}break}this.$super(b);if(this.activeItem){this.activeItem.handleEvent(b)}b.stopPropagation()},handleKeyNavigation:function(c){var b=function(){var a=this.indexOf(this.activeItem)-1;while(a>=0&&(!this.items[a].getEnabled()||!this.items[a].getVisible()||(this.items[a].getStyle()&gara.SEPARATOR)===gara.SEPARATOR)){a--}if(a>=0){this.activateItem(this.items[a])}},f=function(){var a=this.indexOf(this.activeItem)+1;while(a<this.items.length&&(!this.items[a].getEnabled()||!this.items[a].getVisible()||(this.items[a].getStyle()&gara.SEPARATOR)===gara.SEPARATOR)){a++}if(a<this.items.length){this.activateItem(this.items[a])}},d=function(){return this.getParent()!==null&&this.getParent().getParent()!==null&&this.getParent().getParent()instanceof gara.widgets.Menu};if((this.style&gara.BAR)===gara.BAR){switch(c.keyCode){case gara.ARROW_LEFT:b.call(this);break;case gara.ARROW_RIGHT:f.call(this);break;case gara.ARROW_DOWN:if(this.activeItem&&this.activeItem.getMenu()!==null){this.menuBarDropDownShown=true;this.toolBarDropDownShown=true;this.activeItem.getMenu().setVisible(true)}break}}else{switch(c.keyCode){case gara.ARROW_UP:b.call(this);break;case gara.ARROW_DOWN:f.call(this);break;case gara.ESC:this.setVisible(false);if(d.call(this)&&(this.getParent().getParent().getStyle()&gara.BAR)===gara.BAR){this.getParent().getParent().hideMenuBarDropDown()}break;case gara.ARROW_LEFT:if(d.call(this)&&(this.getParent().getParent().getStyle()&gara.BAR)===gara.BAR){this.getParent().getParent().handleKeyNavigation(c)}else if(d.call(this)&&(this.getParent().getParent().getStyle()&gara.BAR)!==gara.BAR){this.setVisible(false)}break;case gara.ARROW_RIGHT:if(this.activeItem.getMenu()!==null){this.activeItem.getMenu().setVisible(true)}else if(d.call(this)&&(this.getParent().getParent().getStyle()&gara.BAR)===gara.BAR){this.getParent().getParent().handleKeyNavigation(c)}break}}},hideMenuBarDropDown:function(){this.menuBarDropDownShown=false;this.toolBarDropDownShown=false},indexOf:function(a){this.checkWidget();if(!(a instanceof gara.widgets.MenuItem)){throw new TypeError("item is not instance of gara.widgets.MenuItem");}return this.items.indexOf(a)},isVisible:function(){return this.visible},releaseChildren:function(){this.items.forEach(function(a){a.release()},this);this.$super()},releaseItem:function(a){if(this.items.contains(a)){this.handle.removeChild(a.handle);this.items.remove(a)}},removeMenuListener:function(a){this.checkWidget();this.menuListeners.remove(a);return this},setEnabled:function(a){this.$super(a);this.handle.tabIndex=this.enabled&&(style&gara.BAR)===gara.BAR?0:-1;return this},setLocation:function(a,c){this.x=a;this.y=c;this.handle.style.top=this.y+"px";this.handle.style.left=this.x+"px";return this},setVisible:function(c,b){this.checkWidget();this.visible=c;this.handle.style.display=this.visible?"block":"none";if(c){if((this.style&gara.BAR)!==gara.BAR){if(this.items.length){this.activateItem(this.items[0])}}if((this.style&gara.POP_UP)===gara.POP_UP){gara.addEventListener(document,"mousedown",this);if(this.parent instanceof gara.widgets.Control){this.parent.addListener("mousedown",this)}}this.menuListeners.forEach(function(a){if(a.menuShown){a.menuShown(this)}},this)}else{if((this.style&gara.POP_UP)===gara.POP_UP){gara.removeEventListener(document,"mousedown",this);if(this.parent instanceof gara.widgets.Control){this.parent.removeListener("mousedown",this)}}this.items.forEach(function(a){if(a.getMenu()!==null){a.getMenu().setVisible(false)}},this);this.menuListeners.forEach(function(a){if(a.menuHidden){a.menuHidden(this)}},this)}return this},unbindListener:function(a,c){gara.removeEventListener(this.handle,a,c)},update:function(){this.checkWidget();if(!this.handle){this.create()}this.items.forEach(function(a){a.update()},this)}}});