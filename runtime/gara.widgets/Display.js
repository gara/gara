gara.provide("gara.widgets.Display");gara.use("gara.widgets.Widget");gara.use("gara.widgets.Control");gara.use("gara.widgets.Shell");gara.Class("gara.widgets.Display",{focusControl:null,disposeListener:null,widgets:[],shells:[],defaultDisplay:gara.$static(null),activeShell:null,$constructor:function(){var b=this;gara.addEventListener(document,"keydown",this);gara.addEventListener(document,"keypress",this);gara.addEventListener(document,"keyup",this);this.disposeListener={widgetDisposed:function(a){b.removeWidget(a)}}},addWidget:function(a){var b;if(!(a instanceof gara.widgets.Widget)){throw new TypeError("widget is not a gara.widgets.Widget");}if(!this.widgets.contains(a)){this.widgets[this.widgets.length]=a;a.addDisposeListener(this.disposeListener);if(a instanceof gara.widgets.Control){a.addListener("focus",this);a.addListener("blur",this);if(a instanceof gara.widgets.Shell&&!this.shells.contains(a)){this.shells[this.shells.length]=a}}}},getActiveShell:function(){return this.activeShell},getClientArea:function(){return document.getElementsByTagName("body")[0]},getDefault:gara.$static(function(){if(gara.widgets.Display.defaultDisplay===null){gara.widgets.Display.defaultDisplay=new gara.widgets.Display()}return gara.widgets.Display.defaultDisplay}),getFocusControl:function(){return this.focusControl},getShells:function(){var b={},c,d,e,h={},f=0,g=[];this.shells.forEach(function(a){if(!a.isDisposed()){e=a.handle.style.zIndex===""?0:a.handle.style.zIndex;if(!h[e]){h[e]=[]}h[e][h[e].length]=a;f=Math.max(f,e)}},this);for(d=f;d>=0;d--){if(h[d]){h[d].forEach(function(a){g[g.length]=a},this)}}return g},getSiblingControls:function(a){var b;if(a.getParent&&a.getParent().getId){b=a.getParent().getId()}else if(a.getParent().id){b=a.getParent().id}if(this.layers[b]){return this.layers[b]}return[]},handleEvent:function(b){var c,d,e,h,f,g,i;switch(b.type){case"keydown":case"keypress":case"keyup":if(this.focusControl!==null&&this.focusControl.handleEvent){b.widget=b.target.widget;b.control=this.focusControl;this.focusControl.handleEvent(b);if(b.item&&b.item.listeners.hasOwnProperty(b.type)){b.target.widget=b.item;b.item.listeners[b.type].forEach(function(a){if(typeof(a)==="object"&&a.handleEvent){a.handleEvent(b)}else if(typeof(a)==="function"){a.call(window,b)}},this)}b.target.widget=b.widget}break;case"focus":if(b.target.widget instanceof gara.widgets.Control){c=b.target.widget;h=true;f={};if(c===this.focusControl){return}e=c.getShell();this.widgets.forEach(function(a){f[a.handle.id]=a.handle.style.zIndex},this);c.moveAbove();d=c;while(e!==null&&d!==e&&d.getParent){d.moveAbove();d=d.getParent()}if(e instanceof gara.widgets.Shell&&!c.handle.hasAttribute("data-gara-suppressFocusNotify")&&!e.setActive()){for(g in f){if(Object.prototype.hasOwnProperty.call(f,g)){document.getElementById(g).style.zIndex=f[g]}}this.activeShell.setFocus();return false}this.focusControl=c;if(!c.handle.hasAttribute("data-gara-suppressFocusNotify")){i=c.notifyFocusListener("focusGained");h=h&&c.handle.hasAttribute("data-gara-forcefocus")?true:i}c.handle.removeAttribute("data-gara-suppressFocusNotify");c.handle.removeAttribute("data-gara-forcefocus");if(!h){for(g in f){if(Object.prototype.hasOwnProperty.call(f,g)){document.getElementById(g).style.zIndex=f[g]}}this.focusControl=null;c.handle.setAttribute("data-gara-suppressBlurNotify",true);c.handle.blur()}}break;case"blur":if(b.target.widget instanceof gara.widgets.Control&&!b.target.hasAttribute("data-gara-suppressBlurNotify")){if(b.target.widget.notifyFocusListener("focusLost")){this.focusControl=null}else{b.target.setAttribute("data-gara-suppressFocusNotify",true);setTimeout(function(){b.target.focus()},0)}}b.target.removeAttribute("data-gara-suppressBlurNotify");break}},removeWidget:function(a){if(!(a instanceof gara.widgets.Widget)){throw new TypeError("widget is not a gara.widgets.Widget");}if(this.widgets.contains(a)){if(this.focusControl===a){this.focusControl=null}a.removeDisposeListener(this.disposeListener);if(a instanceof gara.widgets.Control){a.removeListener("focus",this);a.removeListener("blur",this);if(a instanceof gara.widgets.Shell){this.shells.remove(a)}}this.widgets.remove(a)}},setActiveShell:function(a){if(a!==null&&!(a instanceof gara.widgets.Shell)){throw new TypeError("shell is not a gara.widgets.Shell");}this.activeShell=a},setFocusControl:function(a){if(a!==null&&!(a instanceof gara.widgets.Control)){throw new TypeError("shell is not a gara.widgets.Control");}this.focusControl=a}});