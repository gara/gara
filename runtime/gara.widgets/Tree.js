gara.provide("gara.widgets.Tree","gara.widgets.Composite");gara.use("gara.widgets.TreeItem");gara.Class("gara.widgets.Tree",function(){return{$extends:gara.widgets.Composite,activeItem:null,items:[],rootItems:[],selection:[],selectionListeners:[],showLines:true,shiftItem:null,$constructor:function(a,b){this.items=[];this.rootItems=[];this.showLines=true;this.activeItem=null;this.shiftItem=null;this.selection=[];this.selectionListeners=[];this.treeListeners=[];this.$super(a,b||gara.SINGLE);this.addFocusListener(this)},activateItem:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TreeItem)){throw new TypeError("item is not type of gara.widgets.TreeItem");}if(this.activeItem!==null&&!this.activeItem.isDisposed()){this.activeItem.setActive(false)}this.activeItem=a;this.activeItem.setActive(true);this.handle.setAttribute("aria-activedescendant",this.activeItem.getId())},addItem:function(e,d){var f,g,j,k;this.checkWidget();if(!(e instanceof gara.widgets.TreeItem)){throw new TypeError("item is not type of gara.widgets.TreeItem");}f=e.getParentItem();getDescendents=function(b){var c=0;if(b.getItemCount()>0){b.getItems().forEach(function(a){if(a.getItemCount()>0){c+=getDescendents(a)}c++},this)}return c};if(f===null){k=typeof(d)==="undefined";g=this.rootItems[d];if(g){j=getDescendents(g)+1;this.items.insertAt(j,e);this.rootItems.insertAt(d,e)}else{k=true}if(k){this.items.push(e);this.rootItems.push(e)}}else{d=this.items.indexOf(f)+getDescendents(f);this.items.insertAt(d,e)}return this.handle},addSelectionListener:function(a){this.checkWidget();if(!this.selectionListeners.contains(a)){this.selectionListeners.push(a)}return this},addTreeListener:function(a){this.checkWidget();if(!this.treeListeners.contains(a)){this.treeListeners.push(a)}return this},bindListener:function(a,b){gara.addEventListener(this.handle,a,b)},createWidget:function(){this.createHandle("ul");this.handle.setAttribute("role","tree");this.handle.setAttribute("aria-multiselectable",(this.style&gara.MULTI)===gara.MULTI?true:false);this.handle.setAttribute("aria-activedescendant",this.getId());this.addClass("garaTree");this.setClass("garaTreeFullSelection",(this.style&gara.FULL_SELECTION)===gara.FULL_SELECTION);this.setClass("garaTreeCheckbox",(this.style&gara.CHECK)===gara.CHECK);this.setClass("garaTreeLines",this.showLines);this.setClass("garaTreeNoLines",!this.showLines);this.setClass("garaBorder",(this.style&gara.BORDER)!==0);this.addListener("mousedown",this);this.addListener("contextmenu",this);if((this.style&gara.CHECK)===gara.CHECK){this.addListener("mouseup",this)}},deselect:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TreeItem)){throw new TypeError("item is not type of gara.widgets.TreeItem");}if(this.selection.contains(a)){a.setSelected(false);this.selection.remove(a);this.shiftItem=a;this.notifySelectionListener()}},deselectAll:function(){this.checkWidget();while(this.selection.length){this.selection.pop().setSelected(false)}this.notifySelectionListener()},destroyWidget:function(){this.items=null;this.rootItems=null;this.activeItem=null;this.shiftItem=null;this.selection=null;this.selectionListeners=null;this.treeListeners=null;this.$super()},focusGained:function(){if(this.activeItem===null&&this.items.length){this.activateItem(this.items[0])}},getColumnCount:function(){return 0},getItem:function(a){this.checkWidget();if(typeof(this.rootItems.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}return this.rootItems[a]},getItemCount:function(){return this.rootItems.length},getItemHeight:function(a){return a.handle.offsetHeight+gara.getNumStyle(a.handle,"margin-top")+gara.getNumStyle(a.handle,"margin-bottom")-(a.childContainer.offsetHeight+gara.getNumStyle(a.childContainer,"margin-top")+gara.getNumStyle(a.childContainer,"margin-bottom"))},getItems:function(){return this.rootItems},getLinesVisible:function(){return this.showLines},getSelection:function(){return this.selection},getSelectionCount:function(){return this.selection.length},getTopItem:function(){if(!this.items.length){return null}var a=this.scrolledHandle().scrollTop;var b=0;for(var c=0;c<this.items.length;c++){b+=this.getItemHeight(this.items[c]);if(b>a){return this.items[c]}}},handleEvent:function(a){var b;this.checkWidget();b=a.target.widget||null;a.item=b&&b instanceof gara.widgets.TreeItem?b:this.activeItem;a.widget=this;this.event=a;this.handleMouseEvents(a);if(this.menu!==null&&this.menu.isVisible()){this.menu.handleEvent(a)}else{this.handleKeyEvents(a);this.handleMenu(a)}this.$super(a);if(a.item!==null){a.item.handleEvent(a)}if(a.type==="contextmenu"){a.preventDefault()}a.stopPropagation();return false},handleMouseEvents:function(a){var b=a.item;switch(a.type){case"mousedown":if(b!==null){if(a.ctrlKey&&!a.shiftKey){if(this.selection.contains(b)){this.deselect(b)}else{this.selectAdd(b,true)}}else if(!a.ctrlKey&&a.shiftKey){this.selectShift(b,false)}else if(a.ctrlKey&&a.shiftKey){this.selectShift(b,true)}else{this.selectAdd(b,false)}this.activateItem(b)}break}},handleKeyEvents:function(a){switch(a.type){case"keyup":case"keydown":case"keypress":if(a.type==="keydown"){this.handleKeyNavigation(a)}this.preventScrolling(a);break}},handleKeyNavigation:function(d){var f,g,j,k,r,i,l,m,s,h,n,t,o,u,p,q;p=function(a){if(a.getExpanded()&&a.getItemCount()>0){return p(a.getItems()[a.getItemCount()-1])}else{return a}};q=function(a){var b=0,c,e=a.getItems();for(c=0;c<e.length;++c){b++;if(e[c].getItemCount()>0){b+=q(e[c])}}return b};switch(d.keyCode){case gara.ARROW_UP:if(this.activeItem===this.items[0]){f=false}else{j=this.activeItem.getParentItem();if(j===null){g=this.rootItems}else{g=j.getItems()}k=g.indexOf(this.activeItem);if(k===0){f=j}else{r=g[k-1];f=p(r)}}if(f){i=0;n=this.items.indexOf(this.activeItem);for(l=0;l<(n-1);l++){i+=this.getItemHeight(this.items[l])}m=this.handle.clientHeight+this.handle.scrollTop-gara.getNumStyle(this.handle,"padding-top")-gara.getNumStyle(this.handle,"padding-bottom");s=this.getItemHeight(f);this.handle.scrollTop=i<this.handle.scrollTop?i:(m<i?i-m+s:this.handle.scrollTop);if(!d.ctrlKey&&!d.shiftKey){this.activateItem(f);this.selectAdd(f,false)}else if(d.ctrlKey&&d.shiftKey){this.activateItem(f);this.selectShift(f,true)}else if(d.shiftKey){this.activateItem(f);this.selectShift(f,false)}else if(d.ctrlKey){this.activateItem(f)}}break;case gara.ARROW_DOWN:if(this.activeItem===this.items[this.items.length-1]){h=false}else{j=this.activeItem.getParentItem();if(j===null){g=this.rootItems}else{g=j.getItems()}k=g.indexOf(this.activeItem);if(this.activeItem.getItemCount()>0&&this.activeItem.getExpanded()){h=this.activeItem.getItems()[0]}else if(this.activeItem.getItemCount()>0&&!this.activeItem.getExpanded()){h=this.items[this.items.indexOf(this.activeItem)+q(this.activeItem)+1]}else{h=this.items[this.items.indexOf(this.activeItem)+1]}}if(h){i=0;n=this.items.indexOf(this.activeItem);for(l=0;l<=(n+1);l++){i+=this.getItemHeight(this.items[l])}o=i-this.getItemHeight(h);m=this.handle.clientHeight+this.handle.scrollTop-gara.getNumStyle(this.handle,"padding-top")-gara.getNumStyle(this.handle,"padding-bottom");t=i-this.handle.clientHeight+gara.getNumStyle(this.handle,"padding-top")+gara.getNumStyle(this.handle,"padding-bottom");this.handle.scrollTop=i>m?(t):(this.handle.scrollTop>o?o:this.handle.scrollTop);if(!d.ctrlKey&&!d.shiftKey){this.activateItem(h);this.selectAdd(h,false)}else if(d.ctrlKey&&d.shiftKey){this.activateItem(h);this.selectShift(h,true)}else if(d.shiftKey){this.activateItem(h);this.selectShift(h,false)}else if(d.ctrlKey){this.activateItem(h)}}break;case gara.ARROW_LEFT:u=this.activeItem;this.activeItem.setExpanded(false);this.activateItem(u);break;case gara.ARROW_RIGHT:this.activeItem.setExpanded(true);break;case gara.SPACE:this.activeItem.setChecked(!this.activeItem.getChecked());if(this.selection.contains(this.activeItem)&&d.ctrlKey){this.deselect(this.activeItem)}else{this.selectAdd(this.activeItem,true)}break;case gara.HOME:this.handle.scrollTop=0;if(!d.ctrlKey&&!d.shiftKey){this.activateItem(this.items[0]);this.selectAdd(this.items[0],false)}else if(d.shiftKey){this.activateItem(this.items[0]);this.selectShift(this.items[0],false)}else if(d.ctrlKey){this.activateItem(this.items[0])}break;case gara.END:this.handle.scrollTop=this.handle.scrollHeight-this.handle.clientHeight;if(!d.ctrlKey&&!d.shiftKey){this.activateItem(this.items[this.items.length-1]);this.selectAdd(this.items[this.items.length-1],false)}else if(d.shiftKey){this.activateItem(this.items[this.items.length-1]);this.selectShift(this.items[this.items.length-1],false)}else if(d.ctrlKey){this.activateItem(this.items[this.items.length-1])}break}},indexOf:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TreeItem)){throw new TypeError("item not instance of gara.widgets.TreeItem");}return this.rootItems.indexOf(a)},notifySelectionListener:function(){this.selectionListeners.forEach(function(a){if(a.widgetSelected){a.widgetSelected(this.event)}},this)},notifyTreeListener:function(c,e){var d=true,f=this.event||window.event||{};f.widget=this;f.control=this;f.item=e;this.treeListeners.forEach(function(a){var b;if(a[c]){b=a[c](f);if(typeof(b)!=="undefined"){d=b}}},this);return d},releaseChildren:function(){this.rootItems.forEach(function(a){a.release()},this);this.$super()},releaseItem:function(a){if(this.items.contains(a)){if(this.rootItems.contains(a)){this.handle.removeChild(a.handle)}this.items.remove(a);this.rootItems.remove(a);this.selection.remove(a)}},removeItem:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TreeItem)){throw new TypeError("item not instance of gara.widgets.TreeItem");}this.items.remove(a);this.rootItems.remove(a)},removeAll:function(){this.checkWidget();this.items=[];this.rootItems=[]},removeSelectionListener:function(a){this.checkWidget();this.selectionListeners.remove(a);return this},removeTreeListener:function(a){this.checkWidget();this.treeListeners.remove(a);return this},selectAdd:function(a,b){var c;this.checkWidget();if(!(a instanceof gara.widgets.TreeItem)){throw new TypeError("item is not type of gara.widgets.TreeItem");}if(!b||(this.style&gara.MULTI)!==gara.MULTI){while(this.selection.length){c=this.selection.pop();c.setSelected(false)}}if(!this.selection.contains(a)){a.setSelected(true);this.selection.push(a);this.shiftItem=a;this.notifySelectionListener()}},selectAll:function(){this.checkWidget();if((this.style&gara.SINGLE)!==gara.SINGLE){this.items.forEach(function(a){if(!this.selection.contains(a)){this.selection.push(a);a.setSelected(true)}},this);this.notifySelectionListener()}},selectShift:function(a,b){var c,e,d,f,g;this.checkWidget();if(!(a instanceof gara.widgets.TreeItem)){throw new TypeError("item is not type of gara.widgets.TreeItem");}if(!b){while(this.selection.length){c=this.selection.pop();c.setSelected(false)}}if((this.style&gara.MULTI)===gara.MULTI){e=this.items.indexOf(this.shiftItem);d=this.items.indexOf(a);f=e>d?d:e;g=e<d?d:e;for(var c=f;c<=g;++c){this.selection.push(this.items[c]);this.items[c].setSelected(true)}this.notifySelectionListener()}else{this.selectAdd(a)}},setLinesVisible:function(a){this.showLines=a;this.setClass("garaTreeLines",this.showLines);return this},setSelection:function(b){var c;this.checkWidget();while(this.selection.length){c=this.selection.pop();if(!c.isDisposed()){c.setSelected(false)}}if(b instanceof Array){if(b.length>1&&(this.style&gara.MULTI)===gara.MULTI){b.forEach(function(a){if(!this.selection.contains(a)){a.setSelected(true);this.selection.push(a)}},this);this.notifySelectionListener()}else if(b.length){this.selectAdd(b[b.length-1],true)}}else if(gara.instanceOf(b,gara.widgets.ListItem)){this.selectAdd(this.indexOf(b),true)}return this},setTopItem:function(a){var b,c,e;if(!(a instanceof gara.widgets.TreeItem)){throw new TypeError("item not instance of gara.widgets.TreeItem");}b=this.items.indexOf(a);c=0;for(e=0;e<b;e++){c+=this.getItemHeight(this.items[e])}this.scrolledHandle().scrollTop=c;return this},showItem:function(a){var b,c,e,d;if(!(a instanceof gara.widgets.TreeItem)){throw new TypeError("item not instance of gara.widgets.TreeItem");}if(this.getVerticalScrollbar()){b=this.items.indexOf(a);c=0;for(e=0;e<=b;e++){c+=this.getItemHeight(this.items[e])}if((this.scrolledHandle().scrollTop+this.scrolledHandle().clientHeight)<c||this.scrolledHandle().scrollTop>c){d=c-Math.round(this.getItemHeight(this.items[b])/2)-Math.round(this.scrolledHandle().clientHeight/2);this.scrolledHandle().scrollTop=d}}},showSelection:function(){if(this.selection.length){this.showItem(this.selection[0])}},unbindListener:function(a,b){gara.removeEventListener(this.handle,a,b)},update:function(){var a=0,b,c=this.rootItems.length;this.checkWidget();this.handle.style.width=this.width!==null?(this.width-gara.getNumStyle(this.handle,"padding-left")-gara.getNumStyle(this.handle,"padding-right")-gara.getNumStyle(this.handle,"border-left-width")-gara.getNumStyle(this.handle,"border-right-width"))+"px":"auto";this.handle.style.height=this.height!==null?(this.height-gara.getNumStyle(this.handle,"padding-top")-gara.getNumStyle(this.handle,"padding-bottom")-gara.getNumStyle(this.handle,"border-top-width")-gara.getNumStyle(this.handle,"border-bottom-width"))+"px":"auto";while(a<c){b=this.rootItems[a];if(b.isDisposed()){this.removeItem(b);c--}else{b.update();a++}}}}});