gara.provide("gara.widgets.TabFolder","gara.widgets.Composite");gara.use("gara.widgets.TabItem");gara.use("gara.widgets.Menu");gara.use("gara.widgets.MenuItem");gara.Class("gara.widgets.TabFolder",function(){return{$extends:gara.widgets.Composite,items:[],recents:[],activeItem:null,selectionListeners:[],selection:[],imageQueue:[],dropDownMenu:null,more:null,moreText:null,tabbar:null,clientArea:null,$constructor:function(a,b){this.items=[];this.recents=[];this.activeItem=null;this.selectionListeners=[];this.tabFolderListeners=[];this.selection=[];this.imageQueue=[];this.event=null;this.dropDownMenu=null;this.more=null;this.moreText=null;this.tabbar=null;this.clientArea=null;this.adjustedWidth=null;this.adjustedHeight=null;b=b||gara.TOP|gara.DROP_DOWN;if(!((b&gara.TOP)===gara.TOP)&&!((b&gara.BOTTOM)===gara.BOTTOM)){b|=gara.TOP}if(!((b&gara.MULTI)===gara.MULTI)&&!((b&gara.DROP_DOWN)===gara.DROP_DOWN)){b|=gara.DROP_DOWN}this.$super(a,b)},addItem:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TabItem)){throw new TypeError("item is not type of gara.widgets.TabItem");}this.items.add(a);this.recents.add(a);if(this.activeItem===null){this.activeItem=a;this.activeItem.setActive(true);this.selection=[this.activeItem]}return this.tabbar},addSelectionListener:function(a){this.checkWidget();if(!this.selectionListeners.contains(a)){this.selectionListeners.add(a)}return this},addTabFolderListener:function(a){this.checkWidget();if(!this.tabFolderListeners.contains(a)){this.tabFolderListeners.add(a)}return this},adjustHeight:function(a){var b;this.$super(a);this.adjustedHeight=a;this.updateMeasurements();return this},adjustWidth:function(a){var b;this.$super(a);this.adjustedWidth=a;this.updateMeasurements();return this},activateItem:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TabItem)){throw new TypeError("item is not type of gara.widgets.TabItem");}if(this.activeItem!==null&&!this.activeItem.isDisposed()){this.activeItem.setActive(false)}this.recents.remove(a);this.recents.insertAt(0,a);this.activeItem=a;this.activeItem.setActive(true);this.tabbar.setAttribute("aria-activedescendant",this.activeItem.getId());this.updateMeasurements();if(this.activeItem.getControl()!==null&&this.activeItem.getControl()instanceof gara.widgets.Scrollable){this.activeItem.getControl().setHeight(this.clientArea.clientHeight-gara.getNumStyle(this.clientArea,"padding-top")-gara.getNumStyle(this.clientArea,"padding-bottom"));this.activeItem.getControl().setWidth(this.clientArea.clientWidth-gara.getNumStyle(this.clientArea,"padding-left")-gara.getNumStyle(this.clientArea,"padding-right"))}this.selection=[a];this.notifySelectionListener()},bindListener:function(a,b){gara.addEventListener(this.handle,a,b)},createWidget:function(){var a=this;this.createHandle("div");this.addClass("garaTabFolder");this.addListener("mousedown",this);this.addListener("contextmenu",this);this.tabbar=document.createElement("ul");this.tabbar.id=this.getId()+"-tablist";this.tabbar.widget=this;this.tabbar.control=this;this.tabbar.className="garaTabFolderBar";this.tabbar.setAttribute("role","tablist");this.clientArea=document.createElement("div");this.clientArea.className="garaTabClientArea";if((this.style&gara.TOP)===gara.TOP){this.handle.appendChild(this.tabbar);this.handle.appendChild(this.clientArea);this.addClass("garaTabFolderTopbar")}else{this.handle.appendChild(this.clientArea);this.handle.appendChild(this.tabbar);this.addClass("garaTabFolderBottombar")}if((this.style&gara.DROP_DOWN)===gara.DROP_DOWN){this.more=document.createElement("span");this.moreText=document.createTextNode("");this.more.className="garaTabFolderMore";this.more.style.display="none";this.handle.appendChild(this.more);this.more.appendChild(this.moreText);gara.addEventListener(this.more,"mousedown",this);this.dropDownMenu=new gara.widgets.Menu(this,gara.DROP_DOWN);this.dropDownMenu.addMenuListener({menuHidden:function(){a.handle.style.overflow="auto"}})}},destroyWidget:function(){this.items=null;this.recents=null;this.activeItem=null;this.selectionListeners=null;this.tabFolderListeners=null;this.selection=null;this.imageQueue=null;this.$super()},getClientArea:function(){return this.clientArea},getDropDownMenu:function(){return this.dropDownMenu},getItem:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}return this.items[a]},getItemCount:function(){return this.items.length},getItems:function(){return this.items},getSelection:function(){this.checkWidget();return this.selection},getSelectionIndex:function(){this.checkWidget();if(this.selection.length){return this.items.indexOf(this.selection[0])}else{return-1}},getTabbar:function(){return this.tabbar},handleEvent:function(a){this.checkWidget();var b=a.target.widget||null;a.item=b&&b instanceof gara.widgets.TabItem?b:this.activeItem;a.widget=this;this.event=a;this.handleMouseEvents(a);if(this.menu!==null&&this.menu.isVisible()){this.menu.handleEvent(a)}else{this.handleKeyEvents(a);this.handleMenu(a)}this.$super(a);if(a.item!==null){a.item.handleEvent(a)}if(a.target===this.tabbar&&a.type==="contextmenu"){a.preventDefault()}a.stopPropagation();return false},handleMouseEvents:function(a){switch(a.type){case"mousedown":if(a.target===this.more){var b=top=0,c=this.more;if(this.dropDownMenu.getVisible()){this.dropDownMenu.setVisible(false);return false}if(!this.dropDownMenu.offsetWidth){this.dropDownMenu.setLocation(-1000,-1000);this.dropDownMenu.setVisible(true);this.dropDownMenu.offsetWidth=this.dropDownMenu.handle.offsetWidth}if(c.offsetParent){do{b+=c.offsetLeft-c.scrollLeft;top+=c.offsetTop-c.scrollTop}while(c=c.offsetParent)}this.dropDownMenu.setLocation(b,top+this.more.offsetHeight+2);this.dropDownMenu.setVisible(true)}else{this.activateItem(a.item)}break}},handleKeyEvents:function(a){switch(a.type){case"keydown":this.handleKeyNavigation(a);break}},handleKeyNavigation:function(a){var b,c;switch(a.keyCode){case gara.ARROW_LEFT:if(this.activeItem!==null){c=this.indexOf(this.activeItem)-1;if(c>=0){this.activateItem(this.items[c])}}break;case gara.ARROW_RIGHT:if(this.activeItem!==null){b=this.indexOf(this.activeItem)+1;if(b<this.items.length){this.activateItem(this.items[b])}}break;case gara.HOME:if(this.items.length){this.activateItem(this.items[0])}break;case gara.END:if(this.items.length){this.activateItem(this.items[this.items.length-1])}break}},indexOf:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TabItem)){throw new TypeError("item not instance of gara.widgets.TabItem");}return this.items.indexOf(a)},notifySelectionListener:function(){this.selectionListeners.forEach(function(a){if(a.widgetSelected){a.widgetSelected(this.event)}},this)},notifyTabFolderListener:function(e){var d=true;this.tabFolderListeners.forEach(function(a){var b,c=this.event||window.event||{};c.widget=this;c.control=this;if(a[e]){b=a[e](c);if(typeof(b)!=="undefined"){d=b}}},this);return d},releaseChildren:function(){this.items.forEach(function(a){a.release()},this);this.$super()},releaseItem:function(a){if(this.items.contains(a)){this.tabbar.removeChild(a.handle);this.clientArea.removeChild(a.getClientArea());this.items.remove(a);this.recents.remove(a);if(this.activeItem===a){this.activateItem(this.recents[0])}}},remeasureItems:function(a){a.width+=a.getImage().width;this.imageQueue.remove(a);if(!this.imageQueue.length){this.updateMeasurements()}},remove:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TabItem)){throw new TypeError("item not instance of gara.widgets.TabItem");}this.items.remove(a);if(this.selection.contains(a)){this.selection.remove(a)}a.dispose();delete a},removeIndex:function(a){var b;this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}b=this.items.removeAt(a)[0];if(this.selection.contains(b)){this.selection.remove(b)}b.dispose();delete b},removeRange:function(a,b){for(var c=a;c<=b;++c){this.removeIndex(c)}},removeFromArray:function(b){b.forEach(function(a){this.removeIndex(a)},this)},removeAll:function(){this.checkWidget();while(this.items.length){this.removeIndex(0)}},removeSelectionListener:function(a){this.checkWidget();this.selectionListeners.remove(a);return this},removeTabFolderListener:function(a){this.checkWidget();this.tabFolderListeners.remove(a);return this},scrolledHandle:function(){return this.clientArea},setSelectionItem:function(a){this.checkWidget();if(typeof(this.items.indexOf(index))=="undefined"){throw new RangeError("There is no item for the given index");}this.activateItem(this.items[index]);return this},setSelectionIndex:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}this.activateItem(this.items[a]);return this},setSelectionFromArray:function(a){this.checkWidget();if(a.length){this.activateItem(a[0])}return this},unbindListener:function(a,b){gara.removeEventListener(this.handle,a,b)},update:function(){this.checkWidget();this.updateMeasurements()},updateMeasurements:function(){var c,e,d,f,i,g=0,j=1,h=0,m=false,k,l;if(this.adjustedWidth!==null){this.handle.style.width=this.adjustedWidth+"px";this.tabbar.style.width=this.adjustedWidth+"px"}if(this.adjustedHeight!==null){this.handle.style.height=this.adjustedHeight+"px"}c=this.adjustedWidth!==null?this.adjustedWidth:this.handle.clientWidth;e=this.adjustedHeight!==null?this.adjustedHeight:this.handle.clientHeight;k=(this.style&gara.DROP_DOWN)===gara.DROP_DOWN?this.recents:this.items;i=c;if((this.style&gara.DROP_DOWN)===gara.DROP_DOWN){l=this.more.style.display;this.more.style.display="block";i-=(this.more.offsetWidth+gara.getNumStyle(this.more,"margin-left"));this.more.style.display=l}k.forEach(function(a){var b=this;if(a.isDisposed()){this.remove(a)}else{a.handle.style.display="block";a.update();a.width=a.handle.offsetWidth;if(!a.width){if(a.getImage()!==null&&navigator.userAgent.toLowerCase().indexOf("webkit")!==-1){this.imageQueue.push(a);a.getImage().onload=function(){b.remeasureItems(a)}}}if((this.style&gara.MULTI)===gara.MULTI){if(g+a.handle.offsetWidth>i){j++;g=a.handle.offsetWidth}else{g+=a.handle.offsetWidth}}if((this.style&gara.DROP_DOWN)===gara.DROP_DOWN){if(g+a.width>i){h++}g+=a.width;if(h){a.handle.style.display="none";a.getData("gara__menuItem").setVisible(true)}else{a.handle.style.display="block";a.getData("gara__menuItem").setVisible(false)}}}},this);if((this.style&gara.MULTI)===gara.MULTI&&j>1){this.tabbar.style.height=((this.items[0].handle.offsetHeight*j)-1)+"px"}if((this.style&gara.DROP_DOWN)===gara.DROP_DOWN&&h){this.moreText.nodeValue=h;this.more.style.display="block"}else if((this.style&gara.DROP_DOWN)===gara.DROP_DOWN&&!h){this.more.style.display="none"}f=e-(this.tabbar.offsetHeight+gara.getNumStyle(this.tabbar,"margin-top")+gara.getNumStyle(this.tabbar,"margin-bottom"))-gara.getNumStyle(this.clientArea,"margin-top")-gara.getNumStyle(this.clientArea,"border-top-width")-gara.getNumStyle(this.clientArea,"border-bottom-width")-gara.getNumStyle(this.clientArea,"margin-bottom");this.clientArea.style.height=f+"px";if(this.activeItem!==null){f-=gara.getNumStyle(this.clientArea,"padding-top")-gara.getNumStyle(this.clientArea,"padding-bottom");this.activeItem.getClientArea().style.height=f+"px";if(this.activeItem.getControl()!==null&&this.activeItem.getControl()instanceof gara.widgets.Scrollable){this.activeItem.getControl().setHeight(f)}}d=c-gara.getNumStyle(this.clientArea,"margin-left")-gara.getNumStyle(this.clientArea,"border-left-width")-gara.getNumStyle(this.clientArea,"border-right-width")-gara.getNumStyle(this.clientArea,"margin-right");this.clientArea.style.width=d+"px";if(this.activeItem!==null){d-=gara.getNumStyle(this.clientArea,"padding-left")-gara.getNumStyle(this.clientArea,"padding-right");this.activeItem.getClientArea(d);if(this.activeItem.getControl()!==null&&this.activeItem.getControl()instanceof gara.widgets.Scrollable){this.activeItem.getControl().setWidth(d)}}}}});