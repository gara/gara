gara.provide("gara.widgets.Table","gara.widgets.Composite");gara.use("gara.widgets.TableColumn");gara.use("gara.widgets.TableItem");gara.use("gara.widgets.Menu");gara.Class("gara.widgets.Table",function(){return{$extends:gara.widgets.Composite,SCROLLBAR_WIDTH:19,items:[],columns:[],columnOrder:[],virtualColumn:null,headerVisible:false,linesVisible:false,table:null,thead:null,theadRow:null,tbody:null,checkboxCol:null,selection:[],selectionListeners:[],shiftItem:null,activeItem:null,$constructor:function(a,b){this.items=[];this.columns=[];this.columnOrder=[];this.virtualColumn=null;this.headerVisible=false;this.linesVisible=false;this.table=null;this.thead=null;this.theadRow=null;this.tbody=null;this.colgroup=null;this.checkboxCol=null;this.checkboxCell=null;this.event=null;this.selection=[];this.selectionListeners=[];this.shiftItem=null;this.activeItem=null;this.$super(a,b||gara.SINGLE);this.addFocusListener(this);this.colMenu=new gara.widgets.Menu(this,gara.widgets.POP_UP);this.colMenu.setData(this)},activateItem:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TableItem)){throw new TypeError("item is not type of gara.widgets.TableItem");}if(this.activeItem!==null&&!this.activeItem.isDisposed()){this.activeItem.setActive(false)}this.activeItem=a;this.activeItem.setActive(true);this.handle.setAttribute("aria-activedescendant",this.activeItem.getId())},addItem:function(a,b){this.checkWidget();if(!(a instanceof gara.widgets.TableItem)){throw new TypeError("item is not a gara.widgets.TableItem");}if(typeof(b)!=="undefined"){this.items.insertAt(b,a)}else{this.items.push(a)}return this.tbody},addColumn:function(a,b){this.checkWidget();if(!(a instanceof gara.widgets.TableColumn)){throw new TypeError("column is not a gara.widgets.TableColumn");}if(b){this.columns[b]=a;if(!this.columnOrder.contains(b)){this.columnOrder.push(b)}}else{this.columns.push(a);this.columnOrder.push(this.columns.length-1)}delete this.colMenu.offsetWidth;return this.theadRow},adjustedColWidth:function(b,c){this.items.forEach(function(a){a.adjustWidth(b,c)},this)},adjustHeight:function(a){var b=this.getVerticalScrollbar(),c,d;this.handle.style.height="auto";d=this.getHeaderHeight();this.$super(a);if(a!==null){a=this.handle.clientHeight;this.scroller.style.height=(a-d)+"px"}else{this.scroller.style.height="auto"}this.resizeLine.style.top=d+"px";this.handle.style.paddingTop=d+"px";this.setClass("garaTableVerticalOverflow",this.getVerticalScrollbar()||a===null)},adjustWidth:function(e){var g=0,h=[],f=0,i=false,j;if((this.getStyle()&gara.CHECK)!==0){if(!this.headerVisible){this.setHeaderVisible(true);i=true}f=this.checkboxCell.clientWidth+gara.getNumStyle(this.checkboxCell,"border-right-width")+gara.getNumStyle(this.checkboxCell,"border-left-width");this.checkboxCol.width=f;if(i){this.setHeaderVisible(false)}}j=gara.getStyle(this.scrolledHandle(),"overflow");this.scrolledHandle().style.overflow="hidden";this.$super(e);this.scrolledHandle().style.overflow=j;e=this.handle.clientWidth-(this.getVerticalScrollbar()?gara.SCROLLBAR_WIDTH:0);this.columns.forEach(function(a,b){if(a.getVisible()){var c;if(!a.getWidth()){h.add(a)}else{a.adjustWidth(a.getWidth());f+=a.getWidth()}}},this);e-=f;h.forEach(function(a,b){var c=Math.floor(e/h.length),d=b===h.length-1?e-g:c;a.adjustWidth(d);g+=d},this);if(this.virtualColumn!==null){g+=e;this.virtualColumn.adjustWidth(e)}f+=g+gara.SCROLLBAR_WIDTH;this.table.style.width=(f-gara.SCROLLBAR_WIDTH)+"px";this.thead.style.width=f>this.handle.clientWidth?f+"px":"100%";this.tbody.style.width=(f-gara.SCROLLBAR_WIDTH)+"px";this.setClass("garaTableHorizontalOverflow",f+(this.getVerticalScrollbar()?gara.SCROLLBAR_WIDTH:0)>=this.handle.clientWidth)},addSelectionListener:function(a){this.checkWidget();if(!this.selectionListeners.contains(a)){this.selectionListeners.add(a)}return this},bindListener:function(a,b){gara.addEventListener(this.handle,a,b)},clear:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}this.items[a].clear()},createWidget:function(){var d=this;this.createHandle("div");this.handle.setAttribute("role","grid");this.handle.setAttribute("aria-multiselectable",(this.style&gara.MULTI)===gara.MULTI?true:false);this.handle.setAttribute("aria-activedescendant",this.getId());this.handle.setAttribute("aria-readonly",true);this.addClass("garaTable");this.setClass("garaTableLines",this.linesVisible);this.setClass("garaTableNoLines",!this.linesVisible);this.setClass("garaTableFullSelection",(this.style&gara.FULL_SELECTION)!==0);this.setClass("garaBorder",(this.style&gara.BORDER)!==0);this.scroller=document.createElement("div");this.scroller.id=this.getId()+"-scroller";this.scroller.className="garaTableScroller";this.scroller.widget=this;this.scroller.control=this;this.scroller.setAttribute("role","presentation");this.handle.appendChild(this.scroller);this.table=document.createElement("table");this.table.id=this.getId()+"-table";this.table.widget=this;this.table.control=this;this.table.setAttribute("role","presentation");this.scroller.appendChild(this.table);this.colGroup=document.createElement("colgroup");this.table.appendChild(this.colGroup);this.thead=document.createElement("thead");this.thead.className="garaTableHead";this.thead.id=this.getId()+"-thead";this.thead.widget=this;this.thead.control=this;this.thead.setAttribute("role","presentation");this.thead.style.display=this.headerVisible?(document.all?"block":"table-row-group"):"none";this.table.appendChild(this.thead);this.theadRow=document.createElement("tr");this.theadRow.className="garaTableHeadRow";this.theadRow.id=this.getId()+"-theadRow";this.theadRow.widget=this;this.theadRow.control=this;this.theadRow.setAttribute("role","row");this.thead.appendChild(this.theadRow);if((this.style&gara.CHECK)===gara.CHECK){this.checkboxCol=document.createElement("col");this.colGroup.appendChild(this.checkboxCol);this.checkboxCell=document.createElement("th");this.checkboxCell.className="garaTableHeadCheckboxColumn";this.checkboxCell.setAttribute("role","columnheader");this.theadRow.appendChild(this.checkboxCell);this.addClass("garaTableCheckbox")}this.tbody=document.createElement("tbody");this.tbody.id=this.getId()+"-tbody";this.tbody.widget=this;this.tbody.control=this;this.tbody.setAttribute("role","presentation");this.table.appendChild(this.tbody);this.arrow=document.createElement("div");this.arrow.className="garaTableArrow";this.arrow.id=this.getId()+"-arrow";this.arrow.widget=this;this.arrow.control=this;this.arrow.setAttribute("role","presentation");this.arrow.style.width=gara.SCROLLBAR_WIDTH+"px";this.arrow.style.display=this.headerVisible?"block":"none";this.arrow.appendChild(document.createElement("span"));this.handle.appendChild(this.arrow);gara.addEventListener(this.arrow,"mousedown",function(a){var b=top=0,c=d.arrow;if(d.colMenu.getVisible()){d.colMenu.setVisible(false);return false}if(d.getColumnCount()===0){return false}if(!d.colMenu.offsetWidth){d.colMenu.setLocation(-1000,-1000);d.colMenu.setVisible(true);d.colMenu.offsetWidth=d.colMenu.handle.offsetWidth}if(c.offsetParent){do{b+=c.offsetLeft-c.scrollLeft;top+=c.offsetTop-c.scrollTop}while(c=c.offsetParent)}d.colMenu.setLocation(b-d.colMenu.offsetWidth+d.arrow.offsetWidth,top+d.arrow.offsetHeight+2);d.colMenu.setVisible(true);a.stopPropagation()});this.resizeLine=document.createElement("div");this.resizeLine.className="garaTableResizeLine";this.resizeLine.id=this.getId()+"-resizeLine";this.resizeLine.widget=this;this.resizeLine.control=this;this.resizeLine.setAttribute("role","presentation");this.handle.appendChild(this.resizeLine);this.addListener("mousedown",this);this.addListener("contextmenu",this);if((this.style&gara.CHECK)===gara.CHECK){this.addListener("mouseup",this)}gara.addEventListener(this.scroller,"scroll",function(a){d.thead.style.left=(a.target.scrollLeft*-1)+"px"})},deselect:function(a){var b;this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}b=this.items[a];if(this.selection.contains(b)){b.setSelected(false);this.selection.remove(b);this.shiftItem=b;this.notifySelectionListener()}},deselectAll:function(){this.checkWidget();if(this.selection.length){while(this.selection.length){this.selection.pop().setSelected(false)}this.notifySelectionListener()}},deselectArray:function(b){if(this.selection.length){b.forEach(function(a){if(typeof(this.items.indexOf(a))=="undefined"){return}this.items[a].setSelected(false)},this);this.notifySelectionListener()}},deselectRange:function(a,b){for(var c=a;c<=b;c++){this.items[c].setSelected(false)}this.notifySelectionListener()},destroyWidget:function(){this.items=null;this.columns=null;this.columnOrder=null;this.virtualColumn=null;this.selection=null;this.selectionListeners=null;this.shiftItem=null;this.activeItem=null;this.$super()},focusGained:function(){if(this.activeItem===null&&this.items.length){this.activateItem(this.items[0])}},getColumn:function(a){this.checkWidget();if(typeof(this.columns.indexOf(a))=="undefined"){throw new RangeError("There is no column for the given index");}return this.columns[a]},getColumnCount:function(){return this.columns.length},getColumnOrder:function(){return this.columnOrder},getColumns:function(){return this.columns},getHeaderHeight:function(){return this.theadRow.offsetHeight},getHeaderVisible:function(){return this.headerVisible},getItem:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}return this.items[a]},getItemCount:function(){return this.items.length},getItemHeight:function(a){return a.handle.offsetHeight+gara.getNumStyle(a.handle,"margin-top")+gara.getNumStyle(a.handle,"margin-bottom")},getItems:function(){return this.items},getLinesVisible:function(){return this.linesVisible},getSelection:function(){return this.selection},getSelectionCount:function(){return this.selection.length},getTopItem:function(){var a=this.scrolledHandle().scrollTop,b=0,c;if(!this.items.length){return null}for(c=0;c<this.items.length;c++){b+=this.getItemHeight(this.items[c]);if(b>a){return this.items[c]}}},handleEvent:function(a){var b;this.checkWidget();b=a.target.widget||null;a.item=b&&(b instanceof gara.widgets.TableItem||b instanceof gara.widgets.TableColumn)?b:this.activeItem;a.widget=this;this.event=a;this.handleMouseEvents(a);if(this.menu!==null&&this.menu.isVisible()){this.menu.handleEvent(a)}else{this.handleKeyEvents(a);this.handleMenu(a)}this.$super(a);if(a.item!==null){a.item.handleEvent(a)}if(a.type==="contextmenu"){a.preventDefault()}if(a.type!=="mouseup"){a.stopPropagation()}return false},handleMouseEvents:function(a){var b=a.item;switch(a.type){case"mousedown":if(b instanceof gara.widgets.TableItem){this.activateItem(b);if(!a.ctrlKey&&!a.shiftKey){this.selectAdd(b,false)}else if(a.ctrlKey&&a.shiftKey){this.selectShift(b,true)}else if(a.shiftKey){this.selectShift(b,false)}else if(a.ctrlKey){if(this.selection.contains(b)){this.deselect(this.indexOf(b))}else{this.select(this.indexOf(b),true)}}else{this.select(this.indexOf(b))}}break}},handleKeyEvents:function(a){switch(a.type){case"keyup":case"keydown":case"keypress":if(a.type==="keydown"){this.handleKeyNavigation(a)}this.preventScrolling(a);break}},handleKeyNavigation:function(a){var b,c,d,e,g,h,f,i;switch(a.keyCode){case gara.ARROW_UP:b=false;c=this.indexOf(this.activeItem);if(c!==0){b=this.items[c-1]}if(b){d=0;for(e=0;e<(c-1);e++){d+=this.getItemHeight(this.items[e])}g=this.scroller.clientHeight+this.scroller.scrollTop-gara.getNumStyle(this.scroller,"padding-top")-gara.getNumStyle(this.scroller,"padding-bottom");h=b.handle.clientHeight-gara.getNumStyle(b.handle,"padding-top")-gara.getNumStyle(b.handle,"padding-bottom");this.scroller.scrollTop=d<this.scroller.scrollTop?d:(g<d?d-g+h:this.scroller.scrollTop);if(!a.ctrlKey&&!a.shiftKey){this.activateItem(b);this.selectAdd(b,false)}else if(a.ctrlKey&&a.shiftKey){this.activateItem(b);this.selectShift(b,true)}else if(a.shiftKey){this.activateItem(b);this.selectShift(b,false)}else if(a.ctrlKey){this.activateItem(b)}}break;case gara.ARROW_DOWN:f=false;c=this.indexOf(this.activeItem);if(c!==this.items.length-1){f=this.items[c+1]}if(f){d=0;for(e=0;e<=(c+1);e++){d+=this.getItemHeight(this.items[e])}i=d-this.getItemHeight(f);g=this.scroller.clientHeight+this.scroller.scrollTop-gara.getNumStyle(this.scroller,"padding-top")-gara.getNumStyle(this.scroller,"padding-bottom");scrollRange=d-this.scroller.clientHeight+gara.getNumStyle(this.scroller,"padding-top")+gara.getNumStyle(this.scroller,"padding-bottom");this.scroller.scrollTop=d>g?(scrollRange<0?0:scrollRange):(this.scroller.scrollTop>i?i:this.scroller.scrollTop);if(!a.ctrlKey&&!a.shiftKey){this.activateItem(f);this.selectAdd(f,false)}else if(a.ctrlKey&&a.shiftKey){this.activateItem(f);this.selectShift(f,true)}else if(a.shiftKey){this.activateItem(f);this.selectShift(f,false)}else if(a.ctrlKey){this.activateItem(f)}}break;case gara.SPACE:if((this.style&gara.CHECK)===gara.CHECK){this.activeItem.setChecked(!this.activeItem.getChecked())}if(this.selection.contains(this.activeItem)&&a.ctrlKey){this.deselect(this.indexOf(this.activeItem))}else{this.selectAdd(this.activeItem,true)}break;case gara.HOME:this.scroller.scrollTop=0;if(!a.ctrlKey&&!a.shiftKey){this.activateItem(this.items[0]);this.selectAdd(this.items[0],false)}else if(a.shiftKey){this.activateItem(this.items[0]);this.selectShift(this.items[0],false)}else if(a.ctrlKey){this.activateItem(this.items[0])}break;case gara.END:this.scroller.scrollTop=this.scroller.scrollHeight-this.scroller.clientHeight;if(!a.ctrlKey&&!a.shiftKey){this.activateItem(this.items[this.items.length-1]);this.selectAdd(this.items[this.items.length-1],false)}else if(a.shiftKey){this.activateItem(this.items[this.items.length-1]);this.selectShift(this.items[this.items.length-1],false)}else if(a.ctrlKey){this.activateItem(this.items[this.items.length-1])}break}},indexOf:function(a){this.checkWidget();if(!(a instanceof gara.widgets.TableItem)){throw new TypeError("item not instance of gara.widgets.TableItem");}return this.items.indexOf(a)},getVerticalScrollbar:function(){return this.tbody.clientHeight>this.scroller.clientHeight},notifySelectionListener:function(){this.selectionListeners.forEach(function(a){if(a.widgetSelected){a.widgetSelected(this.event)}},this)},releaseChildren:function(){this.items.forEach(function(a){a.release()},this);this.columns.forEach(function(a){a.release()},this)},releaseColumn:function(a){if(this.columns.contains(a)){this.theadRow.removeChild(a.handle);this.columns.remove(a)}},releaseItem:function(a){if(this.items.contains(a)){this.tbody.removeChild(a.handle);this.items.remove(a);this.selection.remove(a)}},remove:function(a){var b;this.checkWidget();this.releaseItem(this.items[a])},removeArray:function(b){this.checkWidget();b.forEach(function(a){this.remove(a)},this)},removeAll:function(){var a;this.checkWidget();while(this.items.length){a=this.items.pop();this.releaseItem(a)}},removeRange:function(a,b){var c;this.checkWidget();for(c=a;c<=b;++c){this.remove(a)}},removeSelectionListener:function(a){this.checkWidget();this.selectionListeners.remove(a);return this},scrolledHandle:function(){return this.scroller},select:function(a){this.checkWidget();if(typeof(this.items.indexOf(a))=="undefined"){throw new RangeError("There is no item for the given index");}var b=this.items[a];if(!this.selection.contains(b)){b.setSelected(true);this.selection.push(b);this.shiftItem=b;this.notifySelectionListener()}},selectAdd:function(a,b){this.checkWidget();if(!(a instanceof gara.widgets.TableItem)){throw new TypeError("item not instance of gara.widgets.TableItem");}if(!b||(this.style&gara.MULTI)!==gara.MULTI){while(this.selection.length){this.selection.pop().setSelected(false)}}this.select(this.indexOf(a))},selectAll:function(){this.checkWidget();if((this.style&gara.MULTI)===gara.MULTI){this.items.forEach(function(a){if(!this.selection.contains(a)){a.setSelected(true);this.selection.push(a)}},this);this.notifySelectionListener()}},selectArray:function(b){if(!b.length){return}if(b.length>1&&(this.style&gara.MULTI)===gara.MULTI){b.forEach(function(a){if(!this.selection.contains(this.items[a])){this.items[a].setSelected(true);this.selection.push(this.items[a])}},this);this.notifySelectionListener()}else{this.select(b[b.length-1])}},selectRange:function(a,b){var c;if((b-a)>1&&(this.style&gara.MULTI)===gara.MULTI){for(c=a;c<=b;c++){if(!this.selection.contains(this.items[c])){this.items[c].setSelected(true);this.selection.push(this.items[c])}}this.notifySelectionListener()}else{this.select(b)}},selectShift:function(a,b){var c,d,e,g;this.checkWidget();if(!(a instanceof gara.widgets.TableItem)){throw new TypeError("item is not type of gara.widgets.TableItem");}if(!b){while(this.selection.length){this.selection.pop().setSelected(false)}}if((this.style&gara.MULTI)===gara.MULTI){c=this.indexOf(this.shiftItem);d=this.indexOf(a);e=c>d?d:c;g=c<d?d:c;for(var h=e;h<=g;++h){this.selection.push(this.items[h]);this.items[h].setSelected(true)}this.notifySelectionListener()}else{this.select(this.indexOf(a))}},setSelection:function(b){var c;this.checkWidget();while(this.selection.length){c=this.selection.pop();if(!c.isDisposed()){c.setSelected(false)}}if(b instanceof Array){if(b.length>1&&(this.style&gara.MULTI)===gara.MULTI){b.forEach(function(a){if(!this.selection.contains(a)){a.setSelected(true);this.selection.push(a)}},this);this.notifySelectionListener()}else if(b.length){this.select(this.items.indexOf(b[b.length-1]))}}else if(b instanceof gara.widgets.TableItem){this.select(this.indexOf(b))}return this},setColumnOrder:function(a){this.columnOrder=a;return this},setHeaderVisible:function(a){this.headerVisible=a;this.thead.style.display=this.headerVisible?"table-row-group":"none";this.arrow.style.display=this.headerVisible?"block":"none";this.adjustHeight(this.getHeight()||(this.parent instanceof gara.widgets.Composite?this.handle.offsetHeight:null));return this},setLinesVisible:function(a){this.linesVisible=a;this.setClass("garaTableLines",this.linesVisible);this.setClass("garaTableNoLines",!this.linesVisible);return this},setTopItem:function(a){var b,c=0,d;if(!(a instanceof gara.widgets.TableItem)){throw new TypeError("item not instance of gara.widgets.TableItem");}b=this.indexOf(a);for(d=0;d<b;d++){c+=this.getItemHeight(this.items[b])}this.scrolledHandle().scrollTop=c;return this},showItem:function(a){var b,c,d,e;if(!(a instanceof gara.widgets.TableItem)){throw new TypeError("item not instance of gara.widgets.TableItem");}if(this.getVerticalScrollbar()){b=this.indexOf(a);c=0;for(d=0;d<=b;d++){c+=this.getItemHeight(this.items[d])}if((this.scrolledHandle().scrollTop+this.scrolledHandle().clientHeight)<c||this.scrolledHandle().scrollTop>c){e=c-Math.round(this.getItemHeight(this.items[b])/2)-Math.round(this.scrolledHandle().clientHeight/2);this.scrolledHandle().scrollTop=e}}},showSelection:function(){if(this.selection.length){this.showItem(this.selection[0])}},unbindListener:function(a,b){gara.removeEventListener(this.handle,a,b)},update:function(){var b,c;this.checkWidget();if(this.virtualColumn&&this.columns.length){this.virtualColumn.dispose();this.virtualColumn=null}while(this.colGroup.childNodes.length){this.colGroup.removeChild(this.colGroup.childNodes[0])}while(this.theadRow.childNodes.length&&this.columns.length){this.theadRow.removeChild(this.theadRow.childNodes[0])}if((this.style&gara.CHECK)===gara.CHECK){this.theadRow.appendChild(this.checkboxCell);this.colGroup.appendChild(this.checkboxCol)}if(!this.columns.length){this.virtualColumn=new gara.widgets.TableColumn(this);this.columns=[];this.columnOrder=[]}for(b=0,len=this.columnOrder.length;b<len;++b){var c=this.columns[this.columnOrder[b]];if(c.isDisposed()){this.releaseColumn(c)}else if(c.getVisible()){this.theadRow.appendChild(c.handle);this.colGroup.appendChild(c.col)}}this.items.forEach(function(a){a.update()},this);this.updateMeasurements()},updateMeasurements:function(){this.adjustHeight(this.getHeight()||(this.parent instanceof gara.widgets.Composite?this.handle.offsetHeight:null));this.adjustWidth(this.handle.offsetWidth)}}});